<% title = post_title(@post) %>
<% date = post_date(@post) %>
<% category = @post.try(:category) || (@post.respond_to?(:categories) ? @post.categories.first : nil) %>
<% tags = @post.respond_to?(:tags) ? @post.tags : [] %>

<div class="space-y-10">
  <nav class="text-sm text-slate-500">
    <%= link_to "Home", root_path, class: "hover:text-slate-700" %>
    <span class="mx-2 text-slate-300">/</span>
    <span>記事詳細</span>
  </nav>

  <header class="space-y-4">
    <h1 class="text-3xl font-semibold leading-tight tracking-tight text-slate-900 md:text-4xl"><%= title %></h1>
    <div class="flex flex-wrap items-center gap-3 text-sm text-slate-500">
      <% if date.present? %>
        <time datetime="<%= date.iso8601 %>" class="text-sm leading-6"><%= l(date.to_date) %></time>
      <% end %>
      <% if category.present? %>
        <%= link_to category.full_name, posts_path(category_id: category.id), class: "inline-flex items-center rounded-full bg-slate-100 px-3 py-1 text-xs font-semibold text-slate-600 hover:bg-slate-200" %>
      <% end %>
    </div>
    <% if current_user == @post.user %>
      <div class="flex flex-wrap gap-2">
        <%= link_to edit_post_path(@post), class: "inline-flex items-center rounded-xl border border-slate-200 px-3 py-1.5 text-sm font-semibold text-slate-700 transition hover:border-slate-300 hover:text-slate-900" do %>
          <i class="fas fa-edit mr-1"></i>編集
        <% end %>
        <%= link_to @post,
                    method: :delete,
                    data: { confirm: "本当に削除しますか？", turbo_method: :delete },
                    class: "inline-flex items-center rounded-xl border border-rose-200 px-3 py-1.5 text-sm font-semibold text-rose-600 transition hover:bg-rose-50" do %>
          <i class="fas fa-trash mr-1"></i>削除
        <% end %>
      </div>
    <% end %>
    <% if tags.present? %>
      <div class="flex flex-wrap gap-2">
        <% tags.limit(5).each do |tag| %>
          <%= link_to "##{tag.name}", posts_path(tag: tag.name), class: "inline-flex items-center rounded-full border border-slate-200 px-3 py-1 text-xs font-semibold text-slate-600 hover:border-slate-300 hover:bg-slate-50" %>
        <% end %>
      </div>
    <% end %>
  </header>

  <div class="grid gap-10 lg:grid-cols-[minmax(0,1fr)_18rem]">
    <div class="space-y-10">
      <article class="prose prose-slate max-w-none prose-p:leading-7 prose-headings:scroll-mt-24 prose-a:text-brand-600 prose-a:no-underline hover:prose-a:underline">
        <% body_html = post_body_html(@post) %>
        <% if body_html.present? %>
          <%= body_html %>
        <% else %>
          <p>本文がありません。</p>
        <% end %>
      </article>

      <% if current_user == @post.user %>
        <div class="flex flex-wrap gap-2">
          <%= link_to edit_post_path(@post), class: "inline-flex items-center rounded-xl border border-slate-200 px-3 py-1.5 text-sm font-semibold text-slate-700 transition hover:border-slate-300 hover:text-slate-900" do %>
            <i class="fas fa-edit mr-1"></i>編集
          <% end %>
          <%= link_to @post,
                      method: :delete,
                      data: { confirm: "本当に削除しますか？", turbo_method: :delete },
                      class: "inline-flex items-center rounded-xl border border-rose-200 px-3 py-1.5 text-sm font-semibold text-rose-600 transition hover:bg-rose-50" do %>
            <i class="fas fa-trash mr-1"></i>削除
          <% end %>
        </div>
      <% end %>

      <section class="flex flex-wrap items-center gap-4 text-sm text-slate-600">
        <%= render "likes/like_button", post: @post %>
        <%= render "bookmarks/bookmark_button", post: @post, style: :stat %>
        <span class="inline-flex items-center gap-1 text-slate-500">
          <i class="bi bi-chat-left"></i>
          <span><%= @post.comments.count %> コメント</span>
        </span>
      </section>

      <% if tags.present? %>
        <section class="space-y-2">
          <h2 class="text-sm font-semibold uppercase tracking-widest text-slate-500">タグ</h2>
          <div class="flex flex-wrap gap-2">
            <% tags.each do |tag| %>
              <%= link_to "##{tag.name}", posts_path(tag: tag.name), class: "inline-flex items-center rounded-full border border-slate-200 px-3 py-1 text-xs font-semibold text-slate-600 hover:border-slate-300 hover:bg-slate-50" %>
            <% end %>
          </div>
        </section>
      <% end %>

      <% if @previous_post || @next_post %>
        <nav class="grid gap-4 sm:grid-cols-2">
          <% if @previous_post %>
            <%= link_to post_path(@previous_post), class: "rounded-2xl border border-slate-200 bg-white p-4 text-sm text-slate-700 shadow-sm transition hover:border-slate-300 hover:bg-slate-50" do %>
              <span class="block text-xs text-slate-500">← 前の記事</span>
              <span class="mt-1 block font-semibold text-slate-900"><%= @previous_post.title %></span>
            <% end %>
          <% end %>
          <% if @next_post %>
            <%= link_to post_path(@next_post), class: "rounded-2xl border border-slate-200 bg-white p-4 text-sm text-slate-700 shadow-sm transition hover:border-slate-300 hover:bg-slate-50" do %>
              <span class="block text-xs text-slate-500">次の記事 →</span>
              <span class="mt-1 block font-semibold text-slate-900"><%= @next_post.title %></span>
            <% end %>
          <% end %>
        </nav>
      <% end %>

      <section class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
        <h2 class="text-lg font-semibold text-slate-900">コメント (<%= @post.comments.count %>)</h2>

        <% if user_signed_in? %>
          <% if ios_app_request? %>
            <%= form_with model: [@post, @comment], local: true, class: "mt-6 space-y-4" do |form| %>
              <div>
                <%= form.text_area :content,
                                   class: "w-full rounded-xl border border-slate-200 bg-white px-4 py-3 text-base leading-7 text-slate-700 shadow-sm focus:border-brand-400 focus:ring-2 focus:ring-brand-200",
                                   rows: 3,
                                   placeholder: "コメントを入力してください..." %>
              </div>
              <div class="grid gap-3 sm:grid-cols-2">
                <label class="inline-flex items-center gap-2 text-sm text-slate-600">
                  <%= form.check_box :paid, class: "h-4 w-4 rounded border-slate-300 text-brand-600 focus:ring-brand-400", id: "comment_paid" %>
                  有料掲載（上位表示）
                </label>
                <%= form.number_field :points,
                                      class: "w-full rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm text-slate-700 shadow-sm focus:border-brand-400 focus:ring-2 focus:ring-brand-200",
                                      min: 0,
                                      placeholder: "ポイント加算" %>
              </div>
              <div class="grid gap-3 sm:grid-cols-2">
                <%= form.number_field :latitude,
                                      step: 0.000001,
                                      class: "w-full rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm text-slate-700 shadow-sm focus:border-brand-400 focus:ring-2 focus:ring-brand-200",
                                      placeholder: "緯度(任意)" %>
                <%= form.number_field :longitude,
                                      step: 0.000001,
                                      class: "w-full rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm text-slate-700 shadow-sm focus:border-brand-400 focus:ring-2 focus:ring-brand-200",
                                      placeholder: "経度(任意)" %>
              </div>
              <div>
                <%= form.submit "コメントを投稿", class: "inline-flex items-center rounded-xl bg-brand-600 px-5 py-2.5 text-sm font-semibold text-white shadow-sm transition hover:bg-brand-500 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-400 focus-visible:ring-offset-2" %>
              </div>
            <% end %>
          <% else %>
            <div class="mt-4 rounded-xl border border-amber-200 bg-amber-50 px-4 py-3 text-sm text-amber-800">
              コメント機能はiOSアプリからのみ利用できます。(作成中)
            </div>
          <% end %>
        <% else %>
          <div class="mt-4 rounded-xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm text-slate-600">
            コメントを投稿するには<%= link_to "ログイン", new_user_session_path, class: "font-semibold text-brand-600 hover:text-brand-500" %>が必要です。
          </div>
        <% end %>

        <% if @post.comments.any? %>
          <div class="mt-6 space-y-4">
            <% @post.comments.includes(:user).merge(Comment.ordered_for_display).each do |comment| %>
              <div class="rounded-xl border border-slate-200 bg-white p-4">
                <div class="flex flex-wrap items-start justify-between gap-2 text-sm">
                  <div class="font-semibold text-slate-800">
                    <%= comment.user&.name || "匿名ユーザー" %>
                    <% if comment.paid %>
                      <span class="ml-2 inline-flex items-center rounded-full bg-amber-100 px-2 py-0.5 text-xs font-semibold text-amber-700">PR</span>
                    <% end %>
                  </div>
                  <div class="flex items-center gap-3 text-xs text-slate-500">
                    <span><%= time_ago_in_words(comment.created_at) %>前</span>
                    <span class="inline-flex items-center rounded-full bg-slate-100 px-2 py-0.5 text-xs font-semibold text-slate-600">PT <%= comment.points || 0 %></span>
                    <% if user_signed_in? && comment.user == current_user && ios_app_request? %>
                      <%= link_to post_comment_path(@post, comment),
                                  data: { confirm: "コメントを削除しますか？", turbo_method: :delete },
                                  class: "text-rose-600 hover:text-rose-500" do %>
                        削除
                      <% end %>
                    <% end %>
                  </div>
                </div>
                <p class="mt-3 text-sm leading-relaxed text-slate-700"><%= simple_format(h(comment.content)) %></p>
              </div>
            <% end %>
          </div>
        <% else %>
          <p class="mt-6 text-sm text-slate-500">まだコメントがありません。</p>
        <% end %>
      </section>
    </div>

    <aside class="hidden lg:block">
      <div class="sticky top-24 space-y-6">
        <div class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm">
          <h2 class="text-sm font-semibold uppercase tracking-widest text-slate-500">カテゴリー</h2>
          <div class="mt-4 space-y-2 text-sm">
            <% if defined?(Category) && Category.exists? %>
              <% Category.order(:name).limit(8).each do |cat| %>
                <%= link_to cat.full_name, posts_path(category_id: cat.id), class: "block rounded-lg px-3 py-2 text-slate-700 hover:bg-slate-50" %>
              <% end %>
            <% else %>
              <p class="text-slate-500">カテゴリーはまだありません。</p>
            <% end %>
          </div>
        </div>

        <div class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm">
          <h2 class="text-sm font-semibold uppercase tracking-widest text-slate-500">最新記事</h2>
          <div class="mt-4 space-y-3 text-sm">
            <% if defined?(Post) %>
              <% Post.published.order(created_at: :desc).limit(5).each do |recent_post| %>
                <%= link_to recent_post.title.presence || recent_post.name, post_path(recent_post), class: "block text-slate-700 hover:text-slate-900" %>
              <% end %>
            <% end %>
          </div>
        </div>
      </div>
    </aside>
  </div>
</div>
