<%= content_for :title, "新規登録 - パスキー認証" %>

<section class="mx-auto w-full max-w-3xl px-4 py-10 sm:px-6 lg:px-8">
  <div class="rounded-2xl border border-slate-200 bg-white shadow-sm">
    <div class="border-b border-slate-200 px-6 py-5">
      <div class="flex items-center gap-3">
        <div class="flex h-10 w-10 items-center justify-center rounded-full bg-emerald-50 text-emerald-600">
          <i class="fas fa-user-plus"></i>
        </div>
        <div>
          <h3 class="text-lg font-semibold text-slate-900">新規登録</h3>
          <p class="text-sm text-slate-500">パスキー認証</p>
        </div>
        <span class="ml-auto inline-flex items-center rounded-full bg-emerald-50 px-3 py-1 text-xs font-semibold text-emerald-700">パスキー認証</span>
      </div>

      <div class="mt-6">
        <div class="h-2 w-full rounded-full bg-slate-100">
          <div id="progress-bar"
               class="h-2 rounded-full bg-emerald-500 transition-[width] duration-500"
               style="width: 33%"
               role="progressbar"
               aria-valuenow="33"
               aria-valuemin="0"
               aria-valuemax="100"></div>
        </div>
        <div class="mt-3 flex justify-between text-xs">
          <span id="step-1-label" class="font-semibold text-slate-900">1. 基本情報</span>
          <span id="step-2-label" class="font-medium text-slate-400">2. パスキー設定</span>
          <span id="step-3-label" class="font-medium text-slate-400">3. 完了</span>
        </div>
      </div>
    </div>

    <div class="px-6 py-6">
      <div id="basic-info-step" class="step">
        <div class="mb-4">
          <h4 class="text-base font-semibold text-slate-900">
            <i class="fas fa-info-circle mr-2 text-slate-500"></i>基本情報の入力
          </h4>
          <p class="mt-1 text-sm text-slate-500">アカウント作成に必要な基本情報を入力してください。</p>
        </div>

        <%= form_with model: @user, url: passkey_registrations_path, id: 'basic-info-form', class: 'space-y-5', local: false, data: { turbo: false, remote: true } do |f| %>
          <div id="error-messages" class="hidden rounded-xl border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-700" role="alert"></div>

          <div>
            <%= f.label :name, "名前", class: "text-sm font-medium text-slate-700" %>
            <%= f.text_field :name,
                             autofocus: true,
                             class: "mt-2 h-11 w-full rounded-xl border border-slate-200 bg-white px-4 text-base text-slate-700 shadow-sm focus:border-slate-300 focus:ring-2 focus:ring-slate-200",
                             required: true,
                             placeholder: "あなたの名前" %>
          </div>

          <div>
            <%= f.label :email, "メールアドレス", class: "text-sm font-medium text-slate-700" %>
            <%= f.email_field :email,
                              class: "mt-2 h-11 w-full rounded-xl border border-slate-200 bg-white px-4 text-base text-slate-700 shadow-sm focus:border-slate-300 focus:ring-2 focus:ring-slate-200",
                              required: true,
                              placeholder: "your@email.com" %>
          </div>

          <div class="rounded-xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm text-slate-700">
            <h6 class="text-sm font-semibold text-slate-900">
              <i class="fas fa-shield-alt mr-2 text-emerald-500"></i>パスキー認証について
            </h6>
            <ul class="mt-2 list-disc pl-5">
              <li><strong>パスワード不要</strong>：生体認証（指紋・顔認証）やセキュリティキーでログイン</li>
              <li><strong>高セキュリティ</strong>：フィッシング攻撃やパスワード漏洩のリスクを排除</li>
              <li><strong>快適な体験</strong>：パスワードを覚える必要がなく、高速ログイン</li>
            </ul>
          </div>

          <div>
            <%= f.submit "次へ：パスキーを設定", class: "inline-flex h-11 w-full items-center justify-center rounded-xl bg-slate-900 px-4 text-sm font-semibold text-white shadow-sm transition hover:bg-slate-800 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-400 focus-visible:ring-offset-2", id: "next-to-passkey" %>
          </div>
        <% end %>
      </div>

      <div id="passkey-setup-step" class="step hidden">
        <div class="mb-4">
          <h4 class="text-base font-semibold text-slate-900">
            <i class="fas fa-fingerprint mr-2 text-slate-500"></i>パスキーの設定
          </h4>
          <p class="mt-1 text-sm text-slate-500">生体認証またはセキュリティキーでアカウントを保護します。</p>
        </div>

        <div class="rounded-2xl border border-slate-200 bg-slate-50 p-6 text-center">
          <div class="passkey-icon mx-auto mb-3 flex h-16 w-16 items-center justify-center rounded-full bg-emerald-50 text-emerald-500">
            <i class="fas fa-fingerprint text-3xl"></i>
          </div>
          <h6 class="text-sm font-semibold text-slate-900">パスキーを設定してください</h6>
          <p class="mt-1 text-sm text-slate-500">お使いのデバイスの生体認証機能を使用します</p>
        </div>

        <div class="mt-6 grid gap-2">
          <button id="setup-passkey-btn"
                  class="inline-flex h-11 items-center justify-center gap-2 rounded-xl bg-emerald-600 px-4 text-sm font-semibold text-white shadow-sm transition hover:bg-emerald-500 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-emerald-300 focus-visible:ring-offset-2">
            <i class="fas fa-fingerprint"></i>パスキーを設定
          </button>
          <button id="back-to-basic"
                  class="inline-flex h-11 items-center justify-center gap-2 rounded-xl border border-slate-200 bg-white px-4 text-sm font-semibold text-slate-700 shadow-sm transition hover:bg-slate-50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-300">
            <i class="fas fa-arrow-left"></i>基本情報に戻る
          </button>
        </div>

        <div id="passkey-status" class="mt-4 hidden text-center text-sm text-slate-600">
          <div class="flex items-center justify-center gap-2">
            <span class="h-4 w-4 animate-spin rounded-full border-2 border-slate-300 border-t-transparent"></span>
            <span>パスキーを設定中です...</span>
          </div>
        </div>
      </div>

      <div id="completion-step" class="step hidden">
        <div class="text-center">
          <div class="mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-emerald-50 text-emerald-500">
            <i class="fas fa-check-circle text-3xl"></i>
          </div>
          <h5 class="text-lg font-semibold text-emerald-600">登録完了</h5>
          <p class="mt-2 text-sm text-slate-500">パスキー認証が正常に設定されました。<br>BrightTalkをお楽しみください！</p>

          <div class="mt-6">
            <button id="go-to-home"
                    class="inline-flex h-11 w-full items-center justify-center rounded-xl bg-slate-900 px-4 text-sm font-semibold text-white shadow-sm transition hover:bg-slate-800 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-400 focus-visible:ring-offset-2">
              <i class="fas fa-home mr-2"></i>ホームへ移動
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="mt-6 text-center text-sm text-slate-600">
    すでにアカウントをお持ちの場合：
    <%= link_to "ログイン", new_user_session_path, class: "font-semibold text-slate-900 hover:text-slate-700" %>
  </div>
</section>

<%= vite_javascript_tag 'new' %>

<script nonce="<%= content_security_policy_nonce %>">
    console.log('Script block starting...');

    function initPasskeyRegistrationFlow() {
        const root = document.getElementById('basic-info-form');
        if (!root || root.dataset.passkeyInit === 'true') return;
        root.dataset.passkeyInit = 'true';

        if (typeof window.startPasskeyRegistration === 'function') {
            console.log('Passkey module loaded successfully');
        } else {
            console.log('Passkey module not loaded yet');
        }

        class PasskeyRegistrationFlow {
            constructor() {
                console.log('PasskeyRegistrationFlow constructor called');
                this.currentStep = 1;
                this.initializeEventListeners();
            }

            initializeEventListeners() {
                console.log('Initializing event listeners');
                const basicInfoForm = document.getElementById('basic-info-form');
                const setupPasskeyBtn = document.getElementById('setup-passkey-btn');
                const backToBasicBtn = document.getElementById('back-to-basic');
                const goToHomeBtn = document.getElementById('go-to-home');
                const submitButton = document.getElementById('next-to-passkey');

                if (basicInfoForm) {
                    basicInfoForm.addEventListener('submit', (e) => {
                        console.log('Form submit event triggered');
                        e.preventDefault();
                        e.stopImmediatePropagation();
                        this.handleBasicInfoSubmission(e);
                    }, true);
                }

                if (submitButton) {
                    submitButton.addEventListener('click', (e) => {
                        console.log('Submit button clicked - preventing default form submission');
                        e.preventDefault();
                        e.stopImmediatePropagation();

                        const form = document.getElementById('basic-info-form');
                        if (form && form.checkValidity()) {
                            this.handleBasicInfoSubmission({
                                target: form, preventDefault: () => {}
                            });
                        } else if (form) {
                            form.reportValidity();
                        }
                    });
                }

                if (setupPasskeyBtn) {
                    setupPasskeyBtn.addEventListener('click', () => this.setupPasskey());
                }

                if (backToBasicBtn) {
                    backToBasicBtn.addEventListener('click', () => this.showStep(1));
                }

                if (goToHomeBtn) {
                    goToHomeBtn.addEventListener('click', () => {
                        window.location.href = '/';
                    });
                }
            }

            async handleBasicInfoSubmission(event) {
                console.log('handleBasicInfoSubmission called');

                if (event.preventDefault) event.preventDefault();
                if (event.stopPropagation) event.stopPropagation();
                if (event.stopImmediatePropagation) event.stopImmediatePropagation();

                const form = event.target || document.getElementById('basic-info-form');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }

                try {
                    const csrfTokenElement = document.querySelector('meta[name="csrf-token"]');
                    if (!csrfTokenElement) {
                        throw new Error('CSRFトークンが見つかりません');
                    }
                    const csrfToken = csrfTokenElement.getAttribute('content');

                    console.log('CSRF Token found:', csrfToken ? 'Yes' : 'No');

                    const formData = new FormData(form);
                    const userData = {
                        user: {
                            name: formData.get('user[name]'),
                            email: formData.get('user[email]')
                        }
                    };

                    console.log('Sending data:', userData);

                    const response = await fetch('<%= passkey_registrations_path %>', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-Token': csrfToken,
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(userData)
                    });

                    console.log('Response status:', response.status);
                    console.log('Response headers:', response.headers.get('content-type'));

                    if (response.headers.get('content-type')?.includes('application/json')) {
                        const data = await response.json();
                        console.log('Response data:', data);

                        if (response.ok && data.success) {
                            console.log('Success - transitioning to step 2');
                            this.showStep(2);
                        } else {
                            this.showErrors(data.errors || ['登録に失敗しました']);
                        }
                    } else {
                        console.log('Received HTML response instead of JSON');
                        const text = await response.text();
                        console.log('Response text:', text.substring(0, 200));

                        if (response.ok) {
                            console.log('HTML response OK - transitioning to step 2');
                            this.showStep(2);
                        } else {
                            this.showErrors(['サーバーエラーが発生しました']);
                        }
                    }
                } catch (error) {
                    console.error('Basic info submission error:', error);
                    this.showErrors(['ネットワークエラーが発生しました: ' + error.message]);
                }
            }

            async setupPasskey() {
                try {
                    this.showPasskeyStatus(true);

                    const challengeResponse = await fetch('<%= register_passkey_passkey_registrations_path %>', {
                        method: 'POST',
                        headers: {
                            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content'),
                            'Accept': 'application/json'
                        }
                    });

                    const challengeData = await challengeResponse.json();

                    if (!challengeResponse.ok || !challengeData.success) {
                        throw new Error(challengeData.error || 'チャレンジ取得に失敗しました');
                    }

                    if (typeof window.startPasskeyRegistration !== 'function') {
                        console.log('startPasskeyRegistration not ready yet, waiting for passkey:ready event...');
                        await new Promise((resolve) => {
                            let settled = false;
                            const onReady = () => {
                                if (settled) return;
                                settled = true;
                                window.removeEventListener('passkey:ready', onReady);
                                resolve();
                            };
                            const timeout = setTimeout(() => {
                                if (settled) return;
                                settled = true;
                                window.removeEventListener('passkey:ready', onReady);
                                resolve();
                            }, 7000);
                            window.addEventListener('passkey:ready', () => {
                                clearTimeout(timeout);
                                onReady();
                            }, {once: true});
                        });
                    }
                    if (typeof window.startPasskeyRegistration !== 'function') {
                        for (let i = 0; i < 30 && typeof window.startPasskeyRegistration !== 'function'; i++) {
                            await new Promise(r => setTimeout(r, 100));
                        }
                    }
                    if (typeof window.startPasskeyRegistration !== 'function') {
                        throw new Error('Passkeyモジュールの読み込みが完了していません。数秒後にもう一度お試しください。');
                    }
                    const result = await window.startPasskeyRegistration(challengeData.publicKey, 'メインパスキー');

                    if (result && result.success) {
                        if (result.show_confirmation_notice) {
                            this.showConfirmationNotice(result.message);
                        } else {
                            this.showStep(3);
                        }
                    } else {
                        throw new Error(result?.error || '登録検証に失敗しました');
                    }

                } catch (error) {
                    console.error('パスキー登録エラー:', error);
                    this.showPasskeyStatus(false);
                    alert('パスキーの設定に失敗しました: ' + error.message);
                }
            }

            showStep(stepNumber) {
                document.querySelectorAll('.step').forEach(step => {
                    step.classList.add('hidden');
                });

                const progressBar = document.getElementById('progress-bar');
                const progressWidth = (stepNumber / 3) * 100;
                progressBar.style.width = progressWidth + '%';
                progressBar.setAttribute('aria-valuenow', progressWidth);

                document.querySelectorAll('[id^="step-"][id$="-label"]').forEach(label => {
                    label.classList.remove('font-semibold', 'text-slate-900');
                    label.classList.add('font-medium', 'text-slate-400');
                });

                const activeLabel = document.getElementById(`step-${stepNumber}-label`);
                activeLabel.classList.remove('font-medium', 'text-slate-400');
                activeLabel.classList.add('font-semibold', 'text-slate-900');

                if (stepNumber === 1) {
                    document.getElementById('basic-info-step').classList.remove('hidden');
                } else if (stepNumber === 2) {
                    document.getElementById('passkey-setup-step').classList.remove('hidden');
                    if (typeof enableSetupPasskeyButtonWhenReady === 'function') {
                        enableSetupPasskeyButtonWhenReady();
                    }
                } else if (stepNumber === 3) {
                    document.getElementById('completion-step').classList.remove('hidden');
                }

                this.currentStep = stepNumber;
            }

            showErrors(errors) {
                const errorDiv = document.getElementById('error-messages');
                errorDiv.innerHTML = `
          <strong class="font-semibold">入力内容を確認してください</strong>
          <ul class="mt-2 list-disc pl-5">${errors.map(error => `<li>${error}</li>`).join('')}</ul>
        `;
                errorDiv.classList.remove('hidden');
                errorDiv.scrollIntoView({behavior: 'smooth', block: 'center'});
            }

            showPasskeyStatus(show) {
                const statusDiv = document.getElementById('passkey-status');
                const setupBtn = document.getElementById('setup-passkey-btn');

                if (show) {
                    statusDiv.classList.remove('hidden');
                    setupBtn.disabled = true;
                    setupBtn.classList.add('opacity-60', 'cursor-not-allowed');
                } else {
                    statusDiv.classList.add('hidden');
                    setupBtn.disabled = false;
                    setupBtn.classList.remove('opacity-60', 'cursor-not-allowed');
                }
            }

            showConfirmationNotice(message) {
                document.querySelectorAll('.step').forEach(step => {
                    step.classList.add('hidden');
                });

                const progressBar = document.getElementById('progress-bar');
                progressBar.style.width = '100%';
                progressBar.setAttribute('aria-valuenow', '100');

                document.querySelectorAll('[id^="step-"][id$="-label"]').forEach(label => {
                    label.classList.remove('font-semibold', 'text-slate-900');
                    label.classList.add('font-medium', 'text-slate-400');
                });
                const step3Label = document.getElementById('step-3-label');
                step3Label.classList.remove('font-medium', 'text-slate-400');
                step3Label.classList.add('font-semibold', 'text-slate-900');

                const completionStep = document.getElementById('completion-step');
                completionStep.innerHTML = `
            <div class="text-center">
              <div class="mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-amber-50 text-amber-600">
                <i class="fas fa-envelope-check text-3xl"></i>
              </div>
              <h5 class="text-lg font-semibold text-amber-600">仮登録完了</h5>
              <p class="mt-2 text-sm text-slate-500">${message}</p>

              <div class="mt-5 rounded-xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm text-slate-700">
                <i class="fas fa-info-circle mr-2 text-slate-500"></i>
                メールが届かない場合は、迷惑メールフォルダもご確認ください。
              </div>

              <div class="mt-6">
                <button id="go-to-login" class="inline-flex h-11 w-full items-center justify-center rounded-xl bg-slate-900 px-4 text-sm font-semibold text-white shadow-sm transition hover:bg-slate-800 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-400 focus-visible:ring-offset-2">
                  <i class="fas fa-sign-in-alt mr-2"></i>ログイン画面へ
                </button>
              </div>
            </div>
          `;
                completionStep.classList.remove('hidden');

                document.getElementById('go-to-login').addEventListener('click', () => {
                    window.location.href = '/users/sign_in';
                });

                this.showPasskeyStatus(false);
            }
        }

        console.log('About to create PasskeyRegistrationFlow instance');
        try {
            new PasskeyRegistrationFlow();
            console.log('PasskeyRegistrationFlow instance created successfully');
        } catch (error) {
            console.error('Error creating PasskeyRegistrationFlow:', error);
        }
    }

    function enableSetupPasskeyButtonWhenReady() {
        const setupBtn = document.getElementById('setup-passkey-btn');
        if (!setupBtn) return;

        const enableButton = () => {
            setupBtn.disabled = false;
            setupBtn.classList.remove('opacity-60', 'cursor-not-allowed');
        };

        if (typeof window.startPasskeyRegistration === 'function') {
            enableButton();
            return;
        }

        let settled = false;
        const onReady = () => {
            if (settled) return;
            settled = true;
            window.removeEventListener('passkey:ready', onReady);
            if (typeof window.startPasskeyRegistration === 'function') enableButton();
        };

        const to = setTimeout(() => {
            if (settled) return;
            settled = true;
            window.removeEventListener('passkey:ready', onReady);
            if (typeof window.startPasskeyRegistration === 'function') enableButton();
        }, 7000);
        window.addEventListener('passkey:ready', () => {
            clearTimeout(to);
            onReady();
        }, {once: true});
    }

    document.addEventListener('DOMContentLoaded', () => {
        initPasskeyRegistrationFlow();
        enableSetupPasskeyButtonWhenReady();
    });
    document.addEventListener('turbo:load', () => {
        initPasskeyRegistrationFlow();
        enableSetupPasskeyButtonWhenReady();
    });
    document.addEventListener('turbo:render', () => {
        initPasskeyRegistrationFlow();
        enableSetupPasskeyButtonWhenReady();
    });
    initPasskeyRegistrationFlow();
    enableSetupPasskeyButtonWhenReady();
</script>

<style nonce="<%= content_security_policy_nonce %>">
    .passkey-icon {
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% {
            transform: scale(1);
            opacity: 1;
        }
        50% {
            transform: scale(1.1);
            opacity: 0.7;
        }
        100% {
            transform: scale(1);
            opacity: 1;
        }
    }
</style>
