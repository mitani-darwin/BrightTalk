<div class="container mt-4" data-turbo="false">
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card">
        <div class="card-header">
          <h4><i class="fas fa-fingerprint me-2"></i>新しいWebAuthn認証を追加</h4>
        </div>
        <div class="card-body">
          <!-- 説明 -->
          <div class="alert alert-info">
            <h6><i class="fas fa-info-circle me-2"></i>WebAuthn認証について</h6>
            <p class="mb-2">Touch ID、Face ID、またはセキュリティキーを使用して、パスワードなしでログインできます。</p>
            <ul class="mb-0">
              <li>より安全で便利なログイン方法です</li>
              <li>生体認証またはセキュリティキーが必要です</li>
              <li>複数の認証方法を登録できます</li>
            </ul>
          </div>

          <!-- 認証名の入力 -->
          <div class="mb-3">
            <label for="credential-name" class="form-label">認証名</label>
            <input type="text" id="credential-name" class="form-control"
                   placeholder="例：MacBook Touch ID、iPhone Face ID など">
            <div class="form-text">この認証方法を識別するための名前を入力してください。</div>
          </div>

          <!-- 登録ボタン -->
          <div class="d-grid gap-2">
            <button type="button" id="register-webauthn-btn" class="btn btn-primary btn-lg">
              <i class="fas fa-fingerprint me-2"></i>WebAuthn認証を登録
            </button>
          </div>

          <!-- 戻るボタン -->
          <div class="d-grid gap-2 mt-3">
            <a href="<%= webauthn_credentials_path %>" class="btn btn-outline-secondary">
              <i class="fas fa-arrow-left me-2"></i>認証管理に戻る
            </a>
          </div>

          <!-- エラーメッセージ -->
          <div id="error-message" class="alert alert-danger mt-3" style="display: none;"></div>

          <!-- 処理中表示 -->
          <div id="processing" class="text-center mt-3" style="display: none;">
            <div class="spinner-border" role="status">
              <span class="visually-hidden">登録中...</span>
            </div>
            <p class="mt-2">WebAuthn認証を登録中...</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('WebAuthn registration page loaded');

        const webauthnOptions = <%= raw @webauthn_options.to_json %>;
        const registerBtn = document.getElementById('register-webauthn-btn');
        const credentialNameInput = document.getElementById('credential-name');
        const errorMessage = document.getElementById('error-message');
        const processing = document.getElementById('processing');

        console.log('WebAuthn options:', webauthnOptions);

        function showError(message) {
            if (errorMessage) {
                errorMessage.textContent = message;
                errorMessage.style.display = 'block';
            }
            if (processing) {
                processing.style.display = 'none';
            }
            if (registerBtn) {
                registerBtn.disabled = false;
                registerBtn.innerHTML = '<i class="fas fa-fingerprint me-2"></i>WebAuthn認証を登録';
            }
        }

        function hideError() {
            if (errorMessage) {
                errorMessage.style.display = 'none';
            }
        }

        function showProcessing() {
            if (processing) {
                processing.style.display = 'block';
            }
            hideError();
            if (registerBtn) {
                registerBtn.disabled = true;
                registerBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>登録中...';
            }
        }

        function getCSRFToken() {
            const token = document.querySelector('meta[name="csrf-token"]');
            return token ? token.getAttribute('content') : '';
        }

        // Base64URL変換関数
        function base64URLToArrayBuffer(base64url) {
            const base64 = base64url.replace(/-/g, '+').replace(/_/g, '/');
            const binaryString = atob(base64);
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function arrayBufferToBase64URL(buffer) {
            const bytes = new Uint8Array(buffer);
            let binary = '';
            for (let i = 0; i < bytes.byteLength; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            const base64 = btoa(binary);
            return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
        }

        // 登録ボタンのクリックイベント
        registerBtn.addEventListener('click', async function(e) {
            e.preventDefault();

            const credentialName = credentialNameInput.value.trim();
            if (!credentialName) {
                showError('認証名を入力してください。');
                return;
            }

            if (!webauthnOptions) {
                showError('WebAuthn登録オプションが取得できませんでした。');
                return;
            }

            showProcessing();

            try {
                console.log('Starting WebAuthn registration...');

                // WebAuthnオプションを変換
                const publicKeyCredentialCreationOptions = {
                    challenge: base64URLToArrayBuffer(webauthnOptions.challenge),
                    rp: webauthnOptions.rp,
                    user: {
                        id: base64URLToArrayBuffer(webauthnOptions.user.id),
                        name: webauthnOptions.user.name,
                        displayName: webauthnOptions.user.displayName
                    },
                    pubKeyCredParams: webauthnOptions.pubKeyCredParams,
                    timeout: webauthnOptions.timeout,
                    authenticatorSelection: webauthnOptions.authenticatorSelection,
                    attestation: webauthnOptions.attestation
                };

                // excludeCredentialsの変換
                if (webauthnOptions.excludeCredentials) {
                    publicKeyCredentialCreationOptions.excludeCredentials = webauthnOptions.excludeCredentials.map(cred => ({
                        type: cred.type,
                        id: base64URLToArrayBuffer(cred.id)
                    }));
                }

                console.log('Converted options:', publicKeyCredentialCreationOptions);

                // WebAuthn登録を実行
                const credential = await navigator.credentials.create({
                    publicKey: publicKeyCredentialCreationOptions
                });

                console.log('WebAuthn credential created:', credential);

                // サーバーのURLを直接指定
                const serverUrl = window.location.origin + '/webauthn_credentials';
                console.log('Sending request to:', serverUrl);

                // 認証データをサーバーに送信
                const fetchOptions = {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'X-CSRF-Token': getCSRFToken(),
                        'X-Requested-With': 'XMLHttpRequest'  // Ajax要求であることを明示
                    },
                    body: JSON.stringify({
                        name: credentialName,
                        credential: {
                            id: credential.id,
                            rawId: arrayBufferToBase64URL(credential.rawId),
                            type: credential.type,
                            response: {
                                clientDataJSON: arrayBufferToBase64URL(credential.response.clientDataJSON),
                                attestationObject: arrayBufferToBase64URL(credential.response.attestationObject)
                            }
                        }
                    }),
                    // タイムアウトを設定
                    signal: AbortSignal.timeout(30000)  // 30秒でタイムアウト
                };

                console.log('Fetch options:', fetchOptions);

                const response = await fetch(serverUrl, fetchOptions);

                console.log('Registration response received');
                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);
                console.log('Response headers:', Object.fromEntries(response.headers.entries()));

                // レスポンス内容を先に取得してデバッグ
                const responseText = await response.text();
                console.log('Raw response text length:', responseText.length);
                console.log('Raw response text start:', responseText.substring(0, 500));

                let result;

                // Content-Typeをチェック
                const contentType = response.headers.get('content-type') || '';
                console.log('Response Content-Type:', contentType);

                if (contentType.includes('application/json')) {
                    try {
                        result = JSON.parse(responseText);
                        console.log('Parsed JSON result:', result);
                    } catch (parseError) {
                        console.error('JSON parse error:', parseError);
                        throw new Error(`無効なJSONレスポンス: ${parseError.message}`);
                    }

                    if (!response.ok) {
                        throw new Error(result.error || `サーバーエラー (${response.status})`);
                    }

                    if (result.success) {
                        // 成功時の処理
                        console.log('Registration successful, redirecting...');
                        window.location.href = result.redirect_url || '/webauthn_credentials';
                    } else {
                        throw new Error(result.error || 'WebAuthn認証の登録に失敗しました');
                    }
                } else {
                    // HTMLレスポンスの場合
                    if (response.ok) {
                        console.log('HTML response received, assuming success');
                        // HTMLレスポンスでも成功として扱う（リダイレクト応答など）
                        window.location.href = '/webauthn_credentials';
                    } else {
                        throw new Error(`サーバーエラー (${response.status}): ${responseText.substring(0, 200)}`);
                    }
                }

            } catch (error) {
                console.error('WebAuthn registration failed:', error);

                let errorMsg = 'WebAuthn認証の登録に失敗しました。';

                if (error.name === 'NotAllowedError') {
                    errorMsg = 'WebAuthn登録がキャンセルされました。';
                } else if (error.name === 'InvalidStateError') {
                    errorMsg = 'この認証キーは既に登録されています。';
                } else if (error.name === 'NotSupportedError') {
                    errorMsg = 'お使いのブラウザはWebAuthnをサポートしていません。';
                } else if (error.name === 'TimeoutError') {
                    errorMsg = 'リクエストがタイムアウトしました。再度お試しください。';
                } else if (error.name === 'TypeError' && error.message.includes('Load failed')) {
                    errorMsg = 'サーバーに接続できませんでした。ネットワーク接続を確認してください。';
                } else {
                    errorMsg = `${errorMsg} ${error.message}`;
                }

                showError(errorMsg);
            }
        });
    });
</script>