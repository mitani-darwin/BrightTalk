<% content_for :title, "生体認証の設定" %>

<div class="container mt-4">
  <div class="row justify-content-center">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <h4 class="mb-0">生体認証の設定</h4>
        </div>
        <div class="card-body">
          <p class="text-muted">
            Touch ID、Face ID、指紋認証などの生体認証を設定できます。
          </p>

          <div id="webauthn-error" class="alert alert-danger" style="display: none;"></div>

          <form id="webauthn-form">
            <div class="mb-3">
              <label for="nickname" class="form-label">デバイス名</label>
              <input type="text" class="form-control" id="nickname" name="nickname"
                     value="メインデバイス"
                     placeholder="例: iPhone, MacBook など">
              <div class="form-text">このデバイスを識別するための名前を入力してください。</div>
            </div>

            <button type="button" id="register-webauthn" class="btn btn-primary">
              <i class="fas fa-fingerprint me-2"></i>生体認証を設定
            </button>
          </form>

          <div class="mt-3">
            <%= link_to "戻る", webauthn_credentials_path, class: "btn btn-secondary" %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="module">
    <% if @options %>
    const webauthnOptions = <%= raw @options.to_json %>;
    console.log('WebAuthn options from server:', webauthnOptions);

    document.addEventListener('DOMContentLoaded', function() {
        const registerButton = document.getElementById('register-webauthn');

        registerButton.addEventListener('click', function() {
            startWebAuthnRegistration(webauthnOptions);
        });
    });
    <% else %>
    console.error('WebAuthn options not available');
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('webauthn-error').style.display = 'block';
        document.getElementById('webauthn-error').textContent = 'WebAuthn設定の初期化に失敗しました。';
    });
    <% end %>
</script>