<div class="container mt-4" data-turbo="false">
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card">
        <div class="card-header">
          <h4><i class="fas fa-fingerprint me-2"></i>パスキー認証を設定</h4>
        </div>
        <div class="card-body">
          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            パスキー認証を設定すると、Touch ID、Face ID、またはセキュリティキーでログインできるようになります。
          </div>

          <form id="passkey-form">
            <div class="mb-3">
              <label for="passkey-label" class="form-label">デバイス名</label>
              <input type="text" id="passkey-label" class="form-control"
                     placeholder="例: iPhone, MacBook, セキュリティキー"
                     value="<%= default_device_name %>" required>
              <div class="form-text">このパスキーを識別するための名前を入力してください。</div>
            </div>

            <div id="error-message" class="alert alert-danger" style="display: none;"></div>

            <div class="d-grid gap-2">
              <button type="submit" id="register-passkey" class="btn btn-primary btn-lg">
                <i class="fas fa-fingerprint me-2"></i>パスキーを登録
              </button>
              <a href="<%= passkeys_path %>" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>戻る
              </a>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card">
        <div class="card-header">
          <h6><i class="fas fa-question-circle me-2"></i>パスキー設定の流れ</h6>
        </div>
        <div class="card-body">
          <ol class="ps-3">
            <li class="mb-2">デバイス名を入力</li>
            <li class="mb-2">「パスキーを登録」をクリック</li>
            <li class="mb-2">生体認証またはPIN入力</li>
            <li>設定完了</li>
          </ol>

          <hr>

          <h6><i class="fas fa-shield-alt me-2"></i>セキュリティについて</h6>
          <ul class="small text-muted list-unstyled">
            <li class="mb-1">• 秘密鍵はデバイス内に保存</li>
            <li class="mb-1">• サーバーには公開鍵のみ送信</li>
            <li class="mb-1">• パスワードより安全</li>
            <li>• フィッシング攻撃に強い</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
    // Base64URL <-> ArrayBuffer ユーティリティ
    function base64urlToBuffer(base64url) {
        const padding = '='.repeat((4 - (base64url.length % 4)) % 4);
        const base64 = (base64url + padding).replace(/-/g, '+').replace(/_/g, '/');
        const raw = atob(base64);
        const bytes = new Uint8Array(raw.length);
        for (let i = 0; i < raw.length; ++i) bytes[i] = raw.charCodeAt(i);
        return bytes.buffer;
    }

    function bufferToBase64url(buffer) {
        const bytes = new Uint8Array(buffer);
        let binary = '';
        for (let i = 0; i < bytes.byteLength; i++) binary += String.fromCharCode(bytes[i]);
        const base64 = btoa(binary);
        return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/g, '');
    }

    function initializePasskeyRegistration() {
        const form = document.getElementById('passkey-form');
        const errorMessage = document.getElementById('error-message');
        const registerBtn = document.getElementById('register-passkey');
        const labelInput = document.getElementById('passkey-label');

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }

        function hideError() {
            errorMessage.style.display = 'none';
        }

        function getCSRFToken() {
            const token = document.querySelector('meta[name="csrf-token"]');
            return token ? token.getAttribute('content') : '';
        }

        if (form) {
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                hideError();

                const label = labelInput.value.trim();
                if (!label) {
                    showError('デバイス名を入力してください。');
                    return;
                }

                if (!('PublicKeyCredential' in window)) {
                    showError('このブラウザはパスキーに対応していません。');
                    return;
                }

                registerBtn.disabled = true;
                registerBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>登録中...';

                try {
                    // サーバーから登録オプションを取得
                    const response = await fetch('<%= new_passkey_path %>', {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        credentials: 'same-origin'
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'サーバーエラーが発生しました。');
                    }

                    const options = await response.json();

                    // WebAuthn形式に変換
                    const publicKey = {
                        ...options,
                        challenge: base64urlToBuffer(options.challenge),
                        user: {
                            ...options.user,
                            id: base64urlToBuffer(options.user.id)
                        },
                        excludeCredentials: (options.excludeCredentials || []).map(cred => ({
                            ...cred,
                            id: base64urlToBuffer(cred.id)
                        }))
                    };

                    // パスキー作成
                    const credential = await navigator.credentials.create({ publicKey });

                    // サーバー送信用に変換
                    const credentialData = {
                        passkey: {
                            label: label,
                            credential: {
                                id: credential.id,
                                rawId: bufferToBase64url(credential.rawId),
                                type: credential.type,
                                response: {
                                    clientDataJSON: bufferToBase64url(credential.response.clientDataJSON),
                                    attestationObject: bufferToBase64url(credential.response.attestationObject)
                                }
                            }
                        }
                    };

                    // サーバーに登録
                    const createResponse = await fetch('<%= passkeys_path %>', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                            'X-CSRF-Token': getCSRFToken()
                        },
                        body: JSON.stringify(credentialData),
                        credentials: 'same-origin'
                    });

                    const result = await createResponse.json();

                    if (createResponse.ok && result.success) {
                        window.location.href = '<%= passkeys_path %>';
                    } else {
                        showError(result.error || 'パスキーの登録に失敗しました。');
                    }

                } catch (error) {
                    console.error('Passkey registration error:', error);
                    showError(error.message || 'パスキーの登録に失敗しました。');
                } finally {
                    registerBtn.disabled = false;
                    registerBtn.innerHTML = '<i class="fas fa-fingerprint me-2"></i>パスキーを登録';
                }
            });
        }
    }

    document.addEventListener('DOMContentLoaded', initializePasskeyRegistration);
    document.addEventListener('turbo:load', initializePasskeyRegistration);
</script>