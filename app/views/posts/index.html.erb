<div class="space-y-6">
  <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
    <div class="space-y-1">
      <h1 class="text-2xl font-bold tracking-tight text-slate-900">投稿一覧</h1>
      <% if params[:category_id].present? || params[:tag].present? || params[:search].present? %>
        <div class="flex flex-wrap items-center gap-2 text-sm text-slate-500">
          <% if params[:category_id].present? %>
            <span class="pill bg-emerald-50 text-emerald-700">
              カテゴリー: <%= Category.find(params[:category_id]).name %>
            </span>
          <% end %>
          <% if params[:tag].present? %>
            <span class="pill bg-indigo-50 text-indigo-700">
              タグ: #<%= params[:tag] %>
            </span>
          <% end %>
          <% if params[:search].present? %>
            <span class="pill bg-amber-50 text-amber-700">
              検索: "<%= params[:search] %>"
            </span>
          <% end %>
        </div>
      <% else %>
        <p class="text-sm text-slate-500">最新のコミュニティ投稿をチェックしましょう。</p>
      <% end %>
    </div>
    <div class="flex flex-wrap items-center gap-2">
      <% if user_signed_in? %>
        <%= link_to '下書き一覧', drafts_posts_path, class: 'btn btn-secondary text-sm' %>
      <% end %>
      <%= link_to '新規投稿', new_post_path, class: 'btn btn-primary text-sm' %>
    </div>
  </div>

  <div class="flex flex-col gap-8 lg:flex-row lg:items-start">
    <!-- サイドバー -->
    <%= render 'shared/sidebar' %>

    <!-- メインコンテンツ -->
    <div class="order-1 w-full space-y-5 lg:order-2 lg:flex-1">
      <% @posts.each do |post| %>
        <article class="card p-5">
          <div class="flex flex-col gap-4">
            <div class="flex flex-wrap items-start justify-between gap-4">
              <div class="flex items-center gap-3">
                <% if post.user.present? %>
                  <%= link_to user_posts_path(post.user), class: "flex h-12 w-12 items-center justify-center overflow-hidden rounded-full bg-brand-50 ring-2 ring-brand-100" do %>
                    <% if post.user.avatar_or_default %>
                      <%= image_tag post.user.avatar_or_default, class: "h-full w-full object-cover" %>
                    <% else %>
                      <i class="fas fa-user text-brand-600"></i>
                    <% end %>
                  <% end %>
                <% else %>
                  <div class="flex h-12 w-12 items-center justify-center rounded-full bg-slate-200 text-slate-500">
                    <i class="fas fa-user"></i>
                  </div>
                <% end %>
                <div class="space-y-1">
                  <%= link_to(post.user&.name || "削除されたユーザー",
                              post.user ? user_posts_path(post.user) : "#",
                              class: "text-sm font-semibold text-slate-800 hover:text-brand-600") %>
                  <div class="flex items-center gap-2 text-xs text-slate-500">
                    <i class="fas fa-calendar-alt"></i>
                    <span><%= post.created_at.strftime("%Y年%m月%d日 %H:%M") %></span>
                  </div>
                </div>
              </div>
              <div class="text-right">
                <h3 class="text-lg font-bold text-slate-900">
                  <%= link_to post.title.presence || "無題", post, class: "hover:text-brand-600" %>
                </h3>
                <% if post.category %>
                  <%= link_to post.category.full_name,
                              posts_path(category_id: post.category.id),
                              class: "badge badge-secondary mt-2" %>
                <% else %>
                  <span class="badge badge-secondary mt-2">未分類</span>
                <% end %>
              </div>
            </div>

            <div class="grid gap-3 md:grid-cols-2">
              <div class="space-y-1">
                <p class="text-xs font-semibold text-slate-500">投稿タイプ</p>
                <p class="text-sm font-semibold text-slate-800">
                  <% if post.post_type.present? %>
                    <%= case post.post_type.name
                        when 'knowledge_sharing' then '知識共有'
                        when 'question' then '質問・相談'
                        when 'discussion' then '議論・討論'
                        when 'tutorial' then 'チュートリアル'
                        when 'experience_sharing' then '体験談・事例'
                        when 'news_update' then 'ニュース・更新'
                        when 'opinion' then '意見・考察'
                        else post.post_type.name
                        end %>
                  <% else %>
                    <span class="text-slate-400">未設定</span>
                  <% end %>
                </p>
              </div>
              <div class="space-y-1">
                <p class="text-xs font-semibold text-slate-500">目的</p>
                <p class="text-sm text-slate-700">
                  <% if post.purpose.present? %>
                    <%= truncate(post.purpose, length: 80) %>
                  <% else %>
                    <span class="text-slate-400">未設定</span>
                  <% end %>
                </p>
              </div>
              <div class="space-y-1">
                <p class="text-xs font-semibold text-slate-500">対象読者</p>
                <p class="text-sm text-slate-700">
                  <% if post.target_audience.present? %>
                    <%= truncate(post.target_audience, length: 60) %>
                  <% else %>
                    <span class="text-slate-400">未設定</span>
                  <% end %>
                </p>
              </div>
            </div>

            <div class="rounded-xl border border-slate-100 bg-slate-50/60 p-4">
              <p class="text-sm leading-relaxed text-slate-700">
                <%= truncate(strip_tags(post.content_as_html), length: 160) %>
              </p>
            </div>

            <div class="flex flex-wrap items-center justify-between gap-3">
              <div class="flex flex-wrap gap-2">
                <% if post.tags.any? %>
                  <% post.tags.limit(3).each do |tag| %>
                    <%= link_to "##{tag.name}", posts_path(tag: tag.name), class: "pill bg-brand-50 text-brand-700 hover:bg-brand-100" %>
                  <% end %>
                  <% if post.tags.count > 3 %>
                    <span class="pill bg-slate-100 text-slate-700">+<%= post.tags.count - 3 %></span>
                  <% end %>
                <% end %>
              </div>

              <div class="flex flex-wrap items-center gap-3 text-sm font-semibold text-slate-700">
                <div class="flex items-center gap-1 text-rose-500">
                  <i class="fas fa-heart"></i>
                  <span><%= post.likes.count %></span>
                </div>
                <%= render 'bookmarks/bookmark_button', post: post, style: :stat %>
                <div class="flex items-center gap-1 text-sky-600">
                  <i class="fas fa-comment"></i>
                  <span><%= post.comments.count %></span>
                </div>
                <%= link_to "続きを読む", post, class: "btn btn-secondary text-xs" %>
              </div>
            </div>
          </div>
        </article>
      <% end %>

      <% if @posts.empty? %>
        <div class="card text-center">
          <div class="px-6 py-12">
            <div class="mx-auto flex h-14 w-14 items-center justify-center rounded-2xl bg-slate-100 text-slate-400">
              <i class="fas fa-inbox fa-lg"></i>
            </div>
            <h4 class="mt-4 text-lg font-bold text-slate-800">投稿がありません</h4>
            <p class="mt-2 text-sm text-slate-500">
              <% if params[:category_id].present? || params[:tag].present? || params[:search].present? %>
                検索条件に合う投稿が見つかりませんでした。
              <% else %>
                最初の投稿を作成してみましょう！
              <% end %>
            </p>
            <% unless params[:category_id].present? || params[:tag].present? || params[:search].present? %>
              <div class="mt-4">
                <%= link_to '新規投稿', new_post_path, class: 'btn btn-primary' %>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>

      <div class="mt-8 flex justify-center">
        <%= paginate @posts, theme: "tailwind" %>
      </div>
    </div>
  </div>
</div>
