<div class="container-fluid">
  <div class="row">
    <!-- 左側サイドバー - カテゴリーとタグ -->
    <div class="col-md-3">
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">フィルター</h5>
        </div>
        <div class="card-body">
          <%= form_with url: posts_path, method: :get, local: true do |form| %>
            <!-- カテゴリーフィルター -->
            <div class="mb-3">
              <%= form.label :category_id, "カテゴリー", class: "form-label" %>
              <%= form.collection_select :category_id, Category.all, :id, :name,
                                         { prompt: "すべてのカテゴリー", selected: params[:category_id] },
                                         { class: "form-select", onchange: "this.form.submit();" } %>
            </div>

            <!-- タグフィルター -->
            <div class="mb-3">
              <%= form.label :tag, "タグ", class: "form-label" %>
              <%= form.text_field :tag, value: params[:tag], class: "form-control",
                                  placeholder: "タグで検索" %>
            </div>

            <!-- 検索フィルター -->
            <div class="mb-3">
              <%= form.label :search, "キーワード検索", class: "form-label" %>
              <%= form.text_field :search, value: params[:search], class: "form-control",
                                  placeholder: "タイトルや内容で検索" %>
            </div>

            <!-- 検索ボタン -->
            <div class="mb-3">
              <%= form.submit "検索", class: "btn btn-outline-primary w-100" %>
            </div>

            <!-- フィルターリセット -->
            <% if params[:category_id].present? || params[:tag].present? || params[:search].present? %>
              <div class="mb-3">
                <%= link_to "フィルターをクリア", posts_path, class: "btn btn-outline-secondary w-100" %>
              </div>
            <% end %>
          <% end %>
        </div>
      </div>

      <!-- カテゴリー一覧 -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">カテゴリー一覧</h5>
        </div>
        <div class="card-body">
          <ul class="list-unstyled">
            <%= link_to posts_path, class: "text-decoration-none d-block mb-2 #{'text-primary fw-bold' if params[:category_id].blank?}" do %>
              すべてのカテゴリー
            <% end %>
            <% Category.all.each do |category| %>
              <li class="mb-1">
                <%= link_to posts_path(category_id: category.id),
                            class: "text-decoration-none d-block #{'text-primary fw-bold' if params[:category_id] == category.id.to_s}" do %>
                  <%= category.name %>
                  <small class="text-muted">(<%= category.posts.published.count %>)</small>
                <% end %>
              </li>
            <% end %>
          </ul>
        </div>
      </div>

      <!-- 人気タグ -->
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">人気タグ</h5>
        </div>
        <div class="card-body">
          <% popular_tags = Tag.joins(:posts).where(posts: { draft: false }).group('tags.id').order('COUNT(posts.id) DESC').limit(20) %>
          <% if popular_tags.any? %>
            <% popular_tags.each do |tag| %>
              <%= link_to posts_path(tag: tag.name),
                          class: "badge bg-light text-dark text-decoration-none me-1 mb-1 #{'bg-primary text-white' if params[:tag] == tag.name}" do %>
                #<%= tag.name %>
              <% end %>
            <% end %>
          <% else %>
            <p class="text-muted mb-0">タグがありません</p>
          <% end %>
        </div>
      </div>
    </div>

    <!-- メインコンテンツ -->
    <div class="col-md-9">
      <!-- ヘッダー部分 -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h1>投稿一覧</h1>
          <% if params[:category_id].present? || params[:tag].present? || params[:search].present? %>
            <small class="text-muted">
              <% if params[:category_id].present? %>
                カテゴリー: <%= Category.find(params[:category_id]).name %>
              <% end %>
              <% if params[:tag].present? %>
                タグ: #<%= params[:tag] %>
              <% end %>
              <% if params[:search].present? %>
                検索: "<%= params[:search] %>"
              <% end %>
            </small>
          <% end %>
        </div>
        <div>
          <%= link_to '新規投稿', new_post_path, class: 'btn btn-primary' %>
          <% if user_signed_in? %>
            <%= link_to '下書き一覧', drafts_posts_path, class: 'btn btn-outline-secondary ms-2' %>
          <% end %>
        </div>
      </div>

      <!-- 投稿一覧（1列レイアウト） -->
      <div class="post-list">
        <% @posts.each do |post| %>
          <article class="post-item border rounded-3 mb-4 bg-white shadow-sm">
            <div class="row g-0">
              <!-- 画像部分 -->
              <% if post.images.attached? %>
                <div class="col-md-4">
                  <%= link_to post do %>
                    <%= image_tag post.images.first, class: "img-fluid rounded-start",
                                  style: "height: 250px; width: 100%; object-fit: cover;" %>
                  <% end %>
                </div>
                <div class="col-md-8">
                  <div class="card-body p-4">
                    <!-- ヘッダー情報 -->
                    <div class="d-flex justify-content-between align-items-start mb-3">
                      <div class="d-flex align-items-center gap-2">
                        <!-- カテゴリーバッジ -->
                        <% if post.category %>
                          <span class="badge bg-primary fs-6 px-2 py-1">
                            <%= post.category.name %>
                          </span>
                        <% end %>
                        <!-- 投稿日 -->
                        <small class="text-muted">
                          <i class="fas fa-calendar-alt"></i>
                          <%= post.created_at.strftime("%Y年%m月%d日") %>
                        </small>
                      </div>
                      <!-- 投稿者 -->
                      <div class="d-flex align-items-center text-muted">
                        <i class="fas fa-user me-1"></i>
                        <small><%= post.user.name %></small>
                      </div>
                    </div>

                    <!-- タイトル -->
                    <h4 class="card-title mb-3">
                      <%= link_to post.title, post, class: "text-decoration-none text-dark fw-bold" %>
                    </h4>

                    <!-- 内容の一部 -->
                    <p class="card-text text-muted mb-3" style="line-height: 1.6;">
                      <%= truncate(post.content, length: 200) %>
                    </p>

                    <!-- フッター部分 -->
                    <div class="d-flex justify-content-between align-items-center pt-3 border-top">
                      <!-- タグ -->
                      <div class="tags">
                        <% if post.tags.any? %>
                          <% post.tags.limit(3).each do |tag| %>
                            <%= link_to "##{tag.name}", posts_path(tag: tag.name),
                                        class: "badge bg-light text-secondary text-decoration-none me-1 border" %>
                          <% end %>
                          <% if post.tags.count > 3 %>
                            <small class="text-muted">+<%= post.tags.count - 3 %>個</small>
                          <% end %>
                        <% end %>
                      </div>

                      <!-- 統計情報 -->
                      <div class="post-stats d-flex align-items-center gap-3">
                        <% if post.likes.any? %>
                          <small class="text-muted d-flex align-items-center">
                            <i class="fas fa-heart text-danger me-1"></i>
                            <%= post.likes.count %>
                          </small>
                        <% end %>
                        <% if post.comments.any? %>
                          <small class="text-muted d-flex align-items-center">
                            <i class="fas fa-comment text-info me-1"></i>
                            <%= post.comments.count %>
                          </small>
                        <% end %>
                        <%= link_to "続きを読む →", post, class: "btn btn-outline-primary btn-sm" %>
                      </div>
                    </div>
                  </div>
                </div>
              <% else %>
                <div class="col-12">
                  <div class="card-body p-4">
                    <!-- ヘッダー情報 -->
                    <div class="d-flex justify-content-between align-items-start mb-3">
                      <div class="d-flex align-items-center gap-2">
                        <!-- カテゴリーバッジ -->
                        <% if post.category %>
                          <span class="badge bg-primary fs-6 px-2 py-1">
                            <%= post.category.name %>
                          </span>
                        <% end %>
                        <!-- 投稿日 -->
                        <small class="text-muted">
                          <i class="fas fa-calendar-alt"></i>
                          <%= post.created_at.strftime("%Y年%m月%d日") %>
                        </small>
                      </div>
                      <!-- 投稿者 -->
                      <div class="d-flex align-items-center text-muted">
                        <i class="fas fa-user me-1"></i>
                        <small><%= post.user.name %></small>
                      </div>
                    </div>

                    <!-- タイトル -->
                    <h4 class="card-title mb-3">
                      <%= link_to post.title, post, class: "text-decoration-none text-dark fw-bold" %>
                    </h4>

                    <!-- 内容の一部 -->
                    <p class="card-text text-muted mb-3" style="line-height: 1.6;">
                      <%= truncate(post.content, length: 200) %>
                    </p>

                    <!-- フッター部分 -->
                    <div class="d-flex justify-content-between align-items-center pt-3 border-top">
                      <!-- タグ -->
                      <div class="tags">
                        <% if post.tags.any? %>
                          <% post.tags.limit(3).each do |tag| %>
                            <%= link_to "##{tag.name}", posts_path(tag: tag.name),
                                        class: "badge bg-light text-secondary text-decoration-none me-1 border" %>
                          <% end %>
                          <% if post.tags.count > 3 %>
                            <small class="text-muted">+<%= post.tags.count - 3 %>個</small>
                          <% end %>
                        <% end %>
                      </div>

                      <!-- 統計情報 -->
                      <div class="post-stats d-flex align-items-center gap-3">
                        <% if post.likes.any? %>
                          <small class="text-muted d-flex align-items-center">
                            <i class="fas fa-heart text-danger me-1"></i>
                            <%= post.likes.count %>
                          </small>
                        <% end %>
                        <% if post.comments.any? %>
                          <small class="text-muted d-flex align-items-center">
                            <i class="fas fa-comment text-info me-1"></i>
                            <%= post.comments.count %>
                          </small>
                        <% end %>
                        <%= link_to "続きを読む →", post, class: "btn btn-outline-primary btn-sm" %>
                      </div>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          </article>
        <% end %>
      </div>

      <!-- 投稿がない場合 -->
      <% if @posts.empty? %>
        <div class="text-center py-5">
          <div class="card shadow-sm border">
            <div class="card-body p-5">
              <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
              <h4 class="text-muted">投稿がありません</h4>
              <p class="text-muted">
                <% if params[:category_id].present? || params[:tag].present? || params[:search].present? %>
                  検索条件に合う投稿が見つかりませんでした。
                <% else %>
                  最初の投稿を作成してみましょう！
                <% end %>
              </p>
              <% unless params[:category_id].present? || params[:tag].present? || params[:search].present? %>
                <%= link_to '新規投稿', new_post_path, class: 'btn btn-primary' %>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>

      <!-- ページネーション -->
      <div class="d-flex justify-content-center mt-5">
        <%= paginate @posts %>
      </div>
    </div>
  </div>
</div>

<style>
    .post-item {
        transition: all 0.3s ease;
        border: 2px solid #e9ecef !important;
        background-color: #ffffff;
    }

    .post-item:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.15) !important;
        border-color: #007bff !important;
    }

    .post-list .post-item {
        margin-bottom: 2.5rem;
    }

    .post-stats .btn-sm {
        font-size: 0.8rem;
        padding: 0.25rem 0.8rem;
    }

    .tags .badge {
        font-size: 0.75rem;
        font-weight: normal;
    }
</style>