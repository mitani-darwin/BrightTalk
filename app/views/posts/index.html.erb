<div class="container-fluid posts-index">
  <div class="row">
    <!-- サイドバーを読み込み -->
    <%= render 'shared/sidebar' %>

    <!-- メインコンテンツ -->
    <div class="col-12 col-lg-9 order-1 order-lg-2 mb-4 mb-lg-0">
      <!-- ヘッダー部分 -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h1>投稿一覧</h1>
          <% if params[:category_id].present? || params[:tag].present? || params[:search].present? %>
            <small class="text-muted">
              <% if params[:category_id].present? %>
                カテゴリー: <%= Category.find(params[:category_id]).name %>
              <% end %>
              <% if params[:tag].present? %>
                タグ: #<%= params[:tag] %>
              <% end %>
              <% if params[:search].present? %>
                検索: "<%= params[:search] %>"
              <% end %>
            </small>
          <% end %>
        </div>
        <div>
          <%= link_to '新規投稿', new_post_path, class: 'btn btn-primary' %>
          <% if user_signed_in? %>
            <%= link_to '下書き一覧', drafts_posts_path, class: 'btn btn-outline-secondary ms-2' %>
          <% end %>
        </div>
      </div>

      <!-- 投稿一覧（1列レイアウト） -->
      <div class="post-list">
        <% @posts.each do |post| %>
          <article class="post-item border rounded-3 mb-4 bg-white shadow-sm">
            <div class="row g-0">
              <!-- 画像・動画は一覧では表示しないため、常にテキストレイアウト -->
              <div class="col-12">
                <div class="card-body p-4">
                    <div class="post-card-header">
                      <div class="post-card-author">
                        <% if post.user&.avatar_or_default %>
                          <%= image_tag post.user.avatar_or_default,
                              class: "rounded-circle avatar-36 object-cover" %>
                        <% else %>
                          <span class="rounded-circle bg-secondary d-inline-flex align-items-center justify-content-center avatar-36">
                            <i class="fas fa-user text-white"></i>
                          </span>
                        <% end %>
                        <div class="post-card-author-info">
                          <%= link_to(post.user&.name || "削除されたユーザー",
                                      post.user ? user_path(post.user) : "#",
                                      class: "text-decoration-none fw-semibold text-dark") %>
                        </div>
                      </div>
                      <div class="post-card-date-title">
                        <h3 class="post-card-title mb-0">
                          <%= link_to post.title.presence || "無題", post %>
                        </h3>
                        <span class="post-card-date text-muted">
                          <i class="fas fa-calendar-alt me-1"></i>
                          <%= post.created_at.strftime("%Y年%m月%d日 %H:%M") %>
                        </span>
                      </div>
                    </div>

                    <div class="post-card-details">
                      <div class="post-card-detail">
                        <span class="post-card-detail-label">投稿タイプ</span>
                        <span class="post-card-detail-value">
                          <% if post.post_type.present? %>
                            <%= case post.post_type.name
                                when 'knowledge_sharing' then '知識共有'
                                when 'question' then '質問・相談'
                                when 'discussion' then '議論・討論'
                                when 'tutorial' then 'チュートリアル'
                                when 'experience_sharing' then '体験談・事例'
                                when 'news_update' then 'ニュース・更新'
                                when 'opinion' then '意見・考察'
                                else post.post_type.name
                                end %>
                          <% else %>
                            <span class="text-muted">未設定</span>
                          <% end %>
                        </span>
                      </div>
                      <div class="post-card-detail">
                        <span class="post-card-detail-label">カテゴリー</span>
                        <span class="post-card-detail-value">
                          <% if post.category %>
                            <%= link_to post.category.full_name,
                                        posts_path(category_id: post.category.id),
                                        class: "post-card-detail-link" %>
                          <% else %>
                            <span class="text-muted">未分類</span>
                          <% end %>
                        </span>
                      </div>
                      <div class="post-card-detail">
                        <span class="post-card-detail-label">目的</span>
                        <span class="post-card-detail-value">
                          <% if post.purpose.present? %>
                            <%= truncate(post.purpose, length: 80) %>
                          <% else %>
                            <span class="text-muted">未設定</span>
                          <% end %>
                        </span>
                      </div>
                      <div class="post-card-detail">
                        <span class="post-card-detail-label">対象読者</span>
                        <span class="post-card-detail-value">
                          <% if post.target_audience.present? %>
                            <%= truncate(post.target_audience, length: 60) %>
                          <% else %>
                            <span class="text-muted">未設定</span>
                          <% end %>
                        </span>
                      </div>
                    </div>

                    <div class="post-card-content-card">
                      <div class="post-card-content-body">
                        <p class="post-card-excerpt">
                          <%= truncate(strip_tags(post.content_as_html), length: 160) %>
                        </p>
                      </div>
                    </div>

                    <div class="post-card-footer">
                      <div class="post-card-tags">
                        <% if post.tags.any? %>
                          <% post.tags.limit(3).each do |tag| %>
                            <%= link_to "##{tag.name}", posts_path(tag: tag.name), class: "post-card-tag" %>
                          <% end %>
                          <% if post.tags.count > 3 %>
                            <span class="post-card-tag post-card-tag--more">+<%= post.tags.count - 3 %></span>
                          <% end %>
                        <% end %>
                      </div>

                      <div class="post-card-stats">
                        <div class="post-card-stat">
                          <i class="fas fa-heart text-danger"></i>
                          <span><%= post.likes.count %></span>
                        </div>
                        <div class="post-card-stat">
                          <i class="fas fa-comment text-info"></i>
                          <span><%= post.comments.count %></span>
                        </div>
                        <%= link_to "続きを読む", post, class: "btn btn-outline-primary btn-sm" %>
                      </div>
                    </div>
                </div>
            </div>
          </article>
        <% end %>
      </div>

      <!-- 投稿がない場合 -->
      <% if @posts.empty? %>
        <div class="text-center py-5">
          <div class="card shadow-sm border">
            <div class="card-body p-5">
              <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
              <h4 class="text-muted">投稿がありません</h4>
              <p class="text-muted">
                <% if params[:category_id].present? || params[:tag].present? || params[:search].present? %>
                  検索条件に合う投稿が見つかりませんでした。
                <% else %>
                  最初の投稿を作成してみましょう！
                <% end %>
              </p>
              <% unless params[:category_id].present? || params[:tag].present? || params[:search].present? %>
                <%= link_to '新規投稿', new_post_path, class: 'btn btn-primary' %>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>

      <!-- ページネーション -->
      <div class="d-flex justify-content-center mt-5">
        <%= paginate @posts %>
      </div>
    </div>
  </div>
</div>
