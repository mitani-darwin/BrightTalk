<div class="row">
  <!-- サイドバー：カテゴリーフィルター -->
  <div class="col-lg-3 mb-4">
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0">
          <i class="fas fa-filter"></i> カテゴリーで絞り込み
        </h5>
      </div>
      <div class="card-body">
        <div class="d-grid gap-2">
          <%= link_to posts_path,
                      class: "btn #{ params[:category_id].blank? ? 'btn-primary' : 'btn-outline-primary' }" do %>
            <i class="fas fa-th"></i> すべて
          <% end %>

          <% @categories.each do |category| %>
            <%= link_to posts_path(category_id: category.id),
                        class: "btn #{ params[:category_id] == category.id.to_s ? 'btn-primary' : 'btn-outline-primary' }" do %>
              <i class="fas fa-tag"></i> <%= category.name %>
            <% end %>
          <% end %>
        </div>
      </div>
    </div>

    <!-- サイドバーに人気タグを追加 -->
    <% if @popular_tags&.any? %>
      <div class="card mt-3">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="fas fa-tags"></i> 人気のタグ
          </h5>
        </div>
        <div class="card-body">
          <div class="d-flex flex-wrap gap-2">
            <% @popular_tags.each do |tag| %>
              <%= link_to posts_path(tag: tag.name),
                          class: "badge bg-secondary text-decoration-none #{'bg-primary' if params[:tag] == tag.name}" do %>
                #<%= tag.name %>
              <% end %>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
  </div>

  <!-- メインコンテンツ：投稿一覧 -->
  <div class="col-lg-9">
    <!-- ヘッダー -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="h2">
        <i class="fas fa-list"></i> 投稿一覧
        <% if params[:category_id].present? %>
          <small class="text-muted">- <%= @categories.find(params[:category_id]).name %></small>
        <% end %>
      </h1>
      <%= link_to new_post_path, class: "btn btn-success" do %>
        <i class="fas fa-plus"></i> 新しい投稿
      <% end %>
    </div>

    <!-- 投稿がない場合 -->
    <% if @posts.empty? %>
      <div class="card">
        <div class="card-body text-center py-5">
          <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
          <h4 class="text-muted">投稿がありません</h4>
          <p class="text-muted">まだ投稿がありません。最初の投稿を作成しませんか？</p>
          <%= link_to "投稿を作成", new_post_path, class: "btn btn-primary" %>
        </div>
      </div>
    <% else %>
      <!-- 投稿カード一覧 -->
      <div class="row">
        <% @posts.each do |post| %>
          <div class="col-12 mb-4">
            <div class="card h-100 shadow-sm">
              <div class="card-body">
                <!-- ヘッダー情報 -->
                <div class="d-flex justify-content-between align-items-start mb-3">
                  <%= link_to user_posts_path(post.user), class: "d-flex align-items-center text-decoration-none" do %>

                    <div class="avatar me-3">
                      <% if post.user.present? %>
                        <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center"
                             style="width: 40px; height: 40px;">
                          <%= post.user.name.first %>
                        </div>
                      <% end %>
                    </div>
                    <div>
                      <h6 class="mb-0 text-dark"><%= post.user.name if post.user %></h6>
                      <small class="text-muted">
                        <i class="fas fa-clock"></i> <%= time_ago_in_words(post.created_at) %>前
                      </small>
                    </div>
                  <% end %>

                  <!-- カテゴリーバッジ -->
                  <%= link_to posts_path(category_id: post.category.id),
                              class: "badge bg-primary text-decoration-none" do %>
                    <i class="fas fa-tag"></i> <%= post.category.name %>
                  <% end %>
                </div>

                <!-- タイトル -->
                <h5 class="card-title">
                  <%= link_to post.title, post, class: "text-decoration-none" %>
                </h5>

                <!-- 投稿カードにタグ表示を追加 -->
                <% if post.tags.any? %>
                  <div class="mb-2">
                    <% post.tags.each do |tag| %>
                      <%= link_to posts_path(tag: tag.name),
                                  class: "badge bg-secondary text-decoration-none me-1" do %>
                        #<%= tag.name %>
                      <% end %>
                    <% end %>
                  </div>
                <% end %>

                <!-- コンテンツプレビュー -->
                <p class="card-text text-muted">
                  <%= truncate(strip_tags(post.content), length: 150) %>
                </p>

                <!-- フッター：いいねとコメント -->
                <div class="d-flex justify-content-between align-items-center">
                  <div class="d-flex align-items-center gap-3">
                    <%= render 'likes/like_button', post: post %>
                    <div class="d-flex align-items-center text-muted">
                      <i class="bi bi-chat-left me-1" style="font-size: 1.1rem;"></i>
                      <span class="small"><%= post.comments.count %></span>
                    </div>
                  </div>

                  <!-- アクションボタン -->
                  <div class="btn-group" role="group">
                    <%= link_to post, class: "btn btn-outline-primary btn-sm" do %>
                      <i class="fas fa-eye"></i> 表示
                    <% end %>

                    <% if current_user == post.user %>
                      <%= link_to edit_post_path(post), class: "btn btn-outline-secondary btn-sm" do %>
                        <i class="fas fa-edit"></i> 編集
                      <% end %>

                      <%= link_to post, method: :delete,
                                  data: {
                                    confirm: "本当に削除しますか？",
                                    turbo_method: :delete
                                  },
                                  class: "btn btn-outline-danger btn-sm" do %>
                        <i class="fas fa-trash"></i> 削除
                      <% end %>
                    <% end %>
                  </div>
                </div>
              </div>
            </div>
          </div>
        <% end %>
      </div>

      <!-- ページネーション -->
      <div class="d-flex justify-content-center mt-5">
        <%= paginate @posts %>
      </div>
    <% end %>
  </div>
</div>