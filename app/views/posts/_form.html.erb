<%= form_with model: post, local: true, multipart: true, class: "needs-validation", novalidate: true do |form| %>
  <% if post.errors.any? %>
    <div class="alert alert-danger">
      <h4><%= pluralize(post.errors.count, "error") %> prohibited this post from being saved:</h4>
      <ul>
        <% post.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="mb-3">
    <%= form.label :title, class: "form-label" %>
    <%= form.text_field :title, class: "form-control", required: true %>
    <div class="invalid-feedback">
      タイトルを入力してください。
    </div>
  </div>

  <div class="mb-3">
    <%= form.label :content, class: "form-label" %>
    <%= form.text_area :content, class: "form-control", rows: 8, required: true %>
    <div class="invalid-feedback">
      内容を入力してください。
    </div>
  </div>

  <div class="mb-3">
    <%= form.label :category_id, "カテゴリー", class: "form-label" %>
    <%= form.collection_select :category_id, Category.all, :id, :name,
                               { prompt: "カテゴリーを選択してください" },
                               { class: "form-select" } %>
  </div>

  <div class="mb-3">
    <%= form.label :tag_list, "タグ（カンマ区切り）", class: "form-label" %>
    <%= form.text_field :tag_list, class: "form-control",
                        placeholder: "例: Ruby, Rails, プログラミング" %>
    <div class="form-text">タグをカンマで区切って入力してください。</div>
  </div>

  <!-- 画像アップロード（複数対応） -->
  <div class="mb-3">
    <%= form.label :images, "画像", class: "form-label" %>
    <%= form.file_field :images, multiple: true, accept: "image/*",
                        class: "form-control", id: "imageInput" %>
    <div class="form-text">複数の画像を選択できます（PNG, JPG, GIF形式、各5MB以下）</div>
  </div>

  <!-- 画像プレビュー -->
  <div id="imagePreview" class="mb-3"></div>

  <!-- 既存画像の表示（編集時） -->
  <% if post.images.attached? %>
    <div class="mb-3">
      <label class="form-label">現在の画像:</label>
      <div class="row">
        <% post.images.each_with_index do |image, index| %>
          <div class="col-md-3 mb-2">
            <%= image_tag image, class: "img-thumbnail", style: "width: 100%; height: 200px; object-fit: cover;" %>
            <div class="mt-1">
              <%= link_to "削除", "#", class: "btn btn-sm btn-outline-danger",
                          onclick: "removeImage(#{index}); return false;" %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <div class="mb-3">
    <%= form.submit post.persisted? ? "更新" : "投稿", class: "btn btn-primary" %>
    <%= link_to "キャンセル", posts_path, class: "btn btn-secondary" %>
  </div>
<% end %>

<script>
    // 画像プレビュー機能
    document.getElementById('imageInput').addEventListener('change', function(e) {
        const preview = document.getElementById('imagePreview');
        preview.innerHTML = '';

        if (this.files) {
            Array.from(this.files).forEach((file, index) => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const div = document.createElement('div');
                        div.className = 'col-md-3 mb-2';
                        div.innerHTML = `
            <img src="${e.target.result}" class="img-thumbnail" style="width: 100%; height: 200px; object-fit: cover;">
            <div class="mt-1">
              <small class="text-muted">${file.name}</small>
            </div>
          `;
                        preview.appendChild(div);
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
    });

    // 既存画像削除機能（実装は後で行う）
    function removeImage(index) {
        // TODO: 既存画像の削除機能を実装
        alert('画像削除機能は後で実装します');
    }
</script>