<div class="row justify-content-center">
  <div class="col-lg-8">
    <!-- ページヘッダー -->
    <div class="d-flex align-items-center mb-4">
      <%= link_to posts_path, class: "btn btn-outline-secondary me-3" do %>
        <i class="fas fa-arrow-left"></i> 戻る
      <% end %>
      <h1 class="h2 mb-0">
        <i class="fas fa-pen"></i> 新規投稿作成
      </h1>
    </div>

    <!-- メインフォームカード -->
    <div class="card shadow-sm">
      <div class="card-header bg-primary text-white">
        <h5 class="card-title mb-0">
          <i class="fas fa-edit"></i> 投稿内容を入力してください
        </h5>
      </div>

      <div class="card-body">
        <%= form_with model: @post, local: true, multipart: true, class: "needs-validation", novalidate: true do |form| %>

          <!-- エラーメッセージ -->
          <% if @post.errors.any? %>
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
              <h6 class="alert-heading">
                <i class="fas fa-exclamation-triangle"></i> 入力エラーがあります
              </h6>
              <ul class="mb-0">
                <% @post.errors.full_messages.each do |message| %>
                  <li><%= message %></li>
                <% end %>
              </ul>
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          <% end %>

          <!-- タイトル入力 -->
          <div class="mb-4">
            <%= form.label :title, class: "form-label fw-bold" do %>
              <i class="fas fa-heading"></i> タイトル <span class="text-danger">*</span>
            <% end %>
            <%= form.text_field :title,
                                class: "form-control form-control-lg #{'is-invalid' if @post.errors[:title].any?}",
                                placeholder: "魅力的なタイトルを入力してください...",
                                maxlength: 100,
                                required: true %>
            <div class="form-text">
              <i class="fas fa-info-circle"></i> 100文字以内で入力してください
            </div>
            <% if @post.errors[:title].any? %>
              <div class="invalid-feedback">
                <%= @post.errors[:title].first %>
              </div>
            <% end %>
          </div>

          <!-- カテゴリー選択 -->
          <div class="mb-4">
            <%= form.label :category_id, class: "form-label fw-bold" do %>
              <i class="fas fa-tag"></i> カテゴリー <span class="text-danger">*</span>
            <% end %>
            <%= form.collection_select :category_id, @categories, :id, :name,
                                       { prompt: "カテゴリーを選択してください" },
                                       { class: "form-select #{'is-invalid' if @post.errors[:category].any?}", required: true } %>
            <% if @post.errors[:category].any? %>
              <div class="invalid-feedback">
                <%= @post.errors[:category].first %>
              </div>
            <% end %>
          </div>

          <!-- 画像アップロード -->
          <div class="mb-4">
            <%= form.label :image, class: "form-label fw-bold" do %>
              <i class="fas fa-image"></i> 画像（オプション）
            <% end %>
            <%= form.file_field :image,
                                class: "form-control #{'is-invalid' if @post.errors[:image].any?}",
                                accept: "image/*",
                                id: "imageInput" %>
            <div class="form-text">
              <i class="fas fa-info-circle"></i> JPEG、PNG、GIF形式、10MB以下のファイルをアップロード可能です
            </div>
            <% if @post.errors[:image].any? %>
              <div class="invalid-feedback">
                <%= @post.errors[:image].first %>
              </div>
            <% end %>

            <!-- 画像プレビュー -->
            <div id="imagePreview" class="mt-3" style="display: none;">
              <div class="card">
                <div class="card-body text-center">
                  <img id="previewImg" src="" alt="プレビュー" class="img-fluid rounded" style="max-height: 200px;">
                  <div class="mt-2">
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeImage()">
                      <i class="fas fa-times"></i> 画像を削除
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- コンテンツ入力 -->
          <div class="mb-4">
            <%= form.label :content, class: "form-label fw-bold" do %>
              <i class="fas fa-align-left"></i> 本文 <span class="text-danger">*</span>
            <% end %>
            <%= form.text_area :content,
                               class: "form-control #{'is-invalid' if @post.errors[:content].any?}",
                               rows: 12,
                               placeholder: "投稿の内容を詳しく書いてください...",
                               required: true %>
            <div class="form-text">
              <i class="fas fa-info-circle"></i> Markdownで記述することができます
            </div>
            <% if @post.errors[:content].any? %>
              <div class="invalid-feedback">
                <%= @post.errors[:content].first %>
              </div>
            <% end %>
          </div>

          <!-- 投稿ガイドライン -->
          <div class="alert alert-info">
            <h6 class="alert-heading">
              <i class="fas fa-lightbulb"></i> 投稿のコツ
            </h6>
            <ul class="mb-0 small">
              <li>読みやすいタイトルをつけましょう</li>
              <li>適切なカテゴリーを選択してください</li>
              <li>具体的で分かりやすい内容を心がけましょう</li>
              <li>画像を追加すると、より魅力的な投稿になります</li>
            </ul>
          </div>

          <!-- アクションボタン -->
          <div class="d-flex gap-3 justify-content-end">
            <%= link_to posts_path, class: "btn btn-outline-secondary" do %>
              <i class="fas fa-times"></i> キャンセル
            <% end %>

            <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#previewModal">
              <i class="fas fa-eye"></i> プレビュー
            </button>

            <%= form.submit "投稿する", class: "btn btn-primary" do %>
              <i class="fas fa-paper-plane"></i> 投稿する
            <% end %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- プレビューモーダル -->
<div class="modal fade" id="previewModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-eye"></i> 投稿プレビュー
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="previewContent">
          <!-- プレビュー内容がここに表示される -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times"></i> 閉じる
        </button>
      </div>
    </div>
  </div>
</div>

<!-- JavaScript -->
<script>
    // 画像プレビュー機能
    document.getElementById('imageInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('previewImg').src = e.target.result;
                document.getElementById('imagePreview').style.display = 'block';
            }
            reader.readAsDataURL(file);
        }
    });

    // 画像削除機能
    function removeImage() {
        document.getElementById('imageInput').value = '';
        document.getElementById('imagePreview').style.display = 'none';
    }

    // プレビュー機能
    document.querySelector('[data-bs-target="#previewModal"]').addEventListener('click', function() {
        const title = document.getElementById('post_title').value;
        const content = document.getElementById('post_content').value;
        const categorySelect = document.getElementById('post_category_id');
        const categoryName = categorySelect.options[categorySelect.selectedIndex].text;
        const imagePreview = document.getElementById('previewImg').src;

        let previewHtml = `
    <div class="card">
      <div class="card-body">
        <h2 class="card-title">${title || 'タイトルなし'}</h2>
        <div class="mb-3">
          <span class="badge bg-primary">${categoryName !== 'カテゴリーを選択してください' ? categoryName : 'カテゴリーなし'}</span>
        </div>
  `;

        if (imagePreview && imagePreview !== '') {
            previewHtml += `<img src="${imagePreview}" class="img-fluid rounded mb-3" alt="投稿画像">`;
        }

        previewHtml += `
        <div class="card-text">
          ${content.replace(/\n/g, '<br>') || 'コンテンツなし'}
        </div>
      </div>
    </div>
  `;

        document.getElementById('previewContent').innerHTML = previewHtml;
    });

    // フォームバリデーション
    (function() {
        'use strict';
        window.addEventListener('load', function() {
            var forms = document.getElementsByClassName('needs-validation');
            var validation = Array.prototype.filter.call(forms, function(form) {
                form.addEventListener('submit', function(event) {
                    if (form.checkValidity() === false) {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    form.classList.add('was-validated');
                }, false);
            });
        }, false);
    })();
</script>

<style>
    .form-control:focus, .form-select:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }

    .card {
        transition: all 0.3s ease;
    }

    .btn {
        transition: all 0.2s ease;
    }

    .btn:hover {
        transform: translateY(-1px);
    }

    #imagePreview {
        animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>