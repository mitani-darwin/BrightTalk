<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize form functionality
        initializeFormFeatures();
        initializeUploadHandlers();
        initializeAutoSave();
        initializeFormValidation();
    });

    // Form features initialization
    function initializeFormFeatures() {
        // Post type and category management
        initializePostTypeManagement();
        initializeCategoryManagement();

        // File upload UI
        initializeFileUploadUI();

        // Content editing features
        initializeContentEditor();

        initializeUpdateProgressModal();
    }

    // Upload handlers
    function initializeUploadHandlers() {
        const imageInput = document.getElementById('imageInput');
        const videoInput = document.getElementById('videoInput');
        const textarea = document.getElementById('contentTextarea');

        // 正しい方法でcodeEditorElementを取得
        const codeEditorElement = textarea?.closest('[data-controller*="code-editor"]');

        if (codeEditorElement) {
            codeEditorElement.addEventListener('code-editor:initialized', () => {
                console.log('CodeEditor is ready for image insertions');
            });
        }

        if (imageInput) {
            imageInput.addEventListener('change', handleImageUpload);
            imageInput.addEventListener('direct-upload:start', handleDirectUploadStart);
            imageInput.addEventListener('direct-upload:end', handleDirectUploadEnd);
            imageInput.addEventListener('direct-upload:error', handleDirectUploadError);
        }

        if (videoInput) {
            videoInput.addEventListener('change', handleVideoUpload);
            videoInput.addEventListener('direct-upload:start', handleDirectUploadStart);
            videoInput.addEventListener('direct-upload:end', handleDirectUploadEnd);
            videoInput.addEventListener('direct-upload:error', handleDirectUploadError);
        }
    }

    // Auto-save functionality
    function initializeAutoSave() {
        // 新規作成または編集の場合のみ自動保存を有効にする
        const form = document.querySelector('form[data-turbo="false"]');
        const isNewOrEdit = form && (window.location.pathname.includes('/new') || window.location.pathname.includes('/edit'));

        if (isNewOrEdit) {
            window.autoSaveEnabled = true;
            setInterval(performAutoSave, 5000);
        }
    }

    // Form validation
    function initializeFormValidation() {
        const form = document.querySelector('.needs-validation');
        if (form) {
            form.addEventListener('submit', function (event) {
                if (!form.checkValidity()) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                form.classList.add('was-validated');
            });
        }
    }

    // Post type management
    function initializePostTypeManagement() {
        const addBtn = document.getElementById('addPostTypeBtn');
        const saveBtn = document.getElementById('savePostTypeBtn');
        const cancelBtn = document.getElementById('cancelPostTypeBtn');
        const form = document.getElementById('newPostTypeForm');

        if (addBtn) {
            addBtn.addEventListener('click', () => toggleForm(form, true));
        }

        if (cancelBtn) {
            cancelBtn.addEventListener('click', () => toggleForm(form, false));
        }

        if (saveBtn) {
            saveBtn.addEventListener('click', saveNewPostType);
        }
    }

    // Category management
    function initializeCategoryManagement() {
        const addBtn = document.getElementById('addCategoryBtn');
        const saveBtn = document.getElementById('saveCategoryBtn');
        const cancelBtn = document.getElementById('cancelCategoryBtn');
        const form = document.getElementById('newCategoryForm');

        if (addBtn) {
            addBtn.addEventListener('click', () => toggleForm(form, true));
        }

        if (cancelBtn) {
            cancelBtn.addEventListener('click', () => toggleForm(form, false));
        }

        if (saveBtn) {
            saveBtn.addEventListener('click', saveNewCategory);
        }
    }

    // File upload UI
    function initializeFileUploadUI() {
        // Image and video deletion buttons
        document.addEventListener('click', function (e) {
            if (e.target.closest('.delete-image-btn')) {
                handleImageDelete(e);
            }

            if (e.target.closest('.delete-video-btn')) {
                handleVideoDelete(e);
            }

            if (e.target.closest('.insert-existing-image')) {
                insertExistingMedia(e, 'image');
            }

            if (e.target.closest('.insert-existing-video')) {
                insertExistingMedia(e, 'video');
            }
        });
    }

    // Content editor features
    function initializeContentEditor() {
        const textarea = document.getElementById('contentTextarea');
        if (textarea) {
            // Add markdown shortcuts or editor features here
            addMarkdownShortcuts(textarea);
        }
    }

    // Helper functions
    function toggleForm(form, show) {
        if (form) {
            form.style.display = show ? 'block' : 'none';
        }
    }

    function handleImageUpload(event) {
        const files = event.target.files;
        const textarea = document.getElementById('contentTextarea');

        for (let file of files) {
            console.log('Image selected:', file.name);

            if (textarea) {
                const markdownLink = `![${file.name}](attachment:${file.name})\n\n`;

                // CodeMirrorの初期化を少し待つ
                setTimeout(() => {
                    insertMarkdownAtCursor(textarea, markdownLink);
                }, 500);
            }
        }
    }

    function handleVideoUpload(event) {
        const file = event.target.files[0];
        const textarea = document.getElementById('contentTextarea');

        if (file) {
            console.log('Video selected:', file.name);

            // Insert Markdown format link into content textarea
            if (textarea) {
                const markdownLink = `[${file.name}](attachment:${file.name})\n\n`;
                // CodeMirrorの初期化を少し待つ
                setTimeout(() => {
                    insertMarkdownAtCursor(textarea, markdownLink);
                }, 500);
            }
        }
    }

    function handleDirectUploadStart(event) {
        showUploadProgress();
        updateUploadStatus('アップロード開始中...', 0);
    }

    function handleDirectUploadEnd(event) {
        updateUploadStatus('アップロード完了', 100);
        setTimeout(hideUploadProgress, 2000);
    }

    function handleDirectUploadError(event) {
        updateUploadStatus('アップロードエラー', 0);
        showError('ファイルのアップロードに失敗しました。');
    }

    function showUploadProgress() {
        const container = document.getElementById('uploadProgressContainer');
        if (container) {
            container.style.display = 'block';
        }
    }

    function hideUploadProgress() {
        const container = document.getElementById('uploadProgressContainer');
        if (container) {
            container.style.display = 'none';
        }
    }

    function updateUploadStatus(text, progress) {
        const statusText = document.getElementById('uploadStatusText');
        const progressBar = document.getElementById('uploadProgressBar');

        if (statusText) statusText.textContent = text;
        if (progressBar) {
            progressBar.style.width = progress + '%';
            progressBar.setAttribute('aria-valuenow', progress);
        }
    }

    function performAutoSave() {
        // Auto-save implementation
        const form = document.querySelector('form[data-turbo="false"]');
        if (form) {
            const formData = new FormData(form);

            console.log('Auto-save: Starting request to /posts/auto_save');

            fetch('/posts/auto_save', {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRF-Token': getCSRFToken(),
                    'Accept': 'application/json',           // 追加
                    'Content-Type': 'application/x-www-form-urlencoded' // 追加
                },
                body: formData
            })
                .then(response => {
                    // デバッグ情報を詳細にログ出力
                    console.log('Auto-save: Response received');
                    console.log('Auto-save: Status:', response.status);
                    console.log('Auto-save: Status text:', response.statusText);
                    console.log('Auto-save: OK:', response.ok);

                    const contentType = response.headers.get('content-type');
                    console.log('Auto-save: Content-Type:', contentType);

                    if (!response.ok) {
                        // エラーレスポンスの内容も確認
                        return response.text().then(text => {
                            console.error('Auto-save: Server error response:', text);
                            throw new Error(`Server error: ${response.status} - ${text.substring(0, 200)}`);
                        });
                    }

                    if (contentType && contentType.includes('application/json')) {
                        return response.json();
                    } else {
                        // 実際のレスポンス内容を確認
                        return response.text().then(text => {
                            console.error('Auto-save: Invalid response format, received:', text.substring(0, 500));
                            console.error('Auto-save: Expected JSON, got Content-Type:', contentType);
                            throw new Error(`Invalid response format. Expected JSON, got: ${contentType}`);
                        });
                    }
                })
                .then(data => {
                    console.log('Auto-save: Success response:', data);
                    if (data && data.success) {
                        showAutoSaveSuccess(data.message);
                        updatePostId(data.post_id);
                    } else {
                        console.warn('Auto-save failed:', data?.message || 'Unknown error');
                    }
                })
                .catch(error => {
                    console.error('Auto-save error details:', {
                        message: error.message,
                        stack: error.stack,
                        name: error.name
                    });
                    // 開発時のみエラーメッセージを表示
                    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                        showAutoSaveError(`自動保存エラー: ${error.message}`);
                    }
                });
        }
    }

    function showAutoSaveError(message) {
        const alert = document.getElementById('autoSaveAlert');
        const messageSpan = document.getElementById('autoSaveMessage');

        if (alert && messageSpan) {
            messageSpan.textContent = message;
            alert.className = 'alert alert-danger alert-dismissible fade show'; // エラー用スタイル
            alert.style.display = 'block';

            setTimeout(() => {
                alert.classList.remove('show');
                setTimeout(() => {
                    alert.style.display = 'none';
                    alert.className = 'alert alert-success alert-dismissible fade'; // 元に戻す
                }, 300);
            }, 8000); // エラーは少し長めに表示
        }
    }

    function showAutoSaveSuccess(message) {
        console.log('showAutoSaveSuccess called with:', message);

        const alert = document.getElementById('autoSaveAlert');
        const messageSpan = document.getElementById('autoSaveMessage');

        console.log('Elements found:', {
            alert: !!alert,
            messageSpan: !!messageSpan,
            alertDisplay: alert?.style.display,
            alertClass: alert?.className
        });

        if (alert && messageSpan) {
            messageSpan.textContent = message + ' ' + new Date().toLocaleTimeString();
            alert.className = 'alert alert-success alert-dismissible fade show';
            alert.style.display = 'block';

            console.log('After setting:', {
                display: alert.style.display,
                className: alert.className
            });

            setTimeout(() => {
                alert.classList.remove('show');
                setTimeout(() => {
                    alert.style.display = 'none';
                }, 300);
            }, 3000);
        }
    }

    function updatePostId(postId) {
        const hiddenInput = document.getElementById('post_id');
        if (hiddenInput && postId) {
            hiddenInput.value = postId;
        }
    }

    function getCSRFToken() {
        const token = document.querySelector('meta[name="csrf-token"]');
        return token ? token.getAttribute('content') : '';
    }

    function saveNewPostType() {
        // Implementation for saving new post type
        console.log('Save new post type');
    }

    function saveNewCategory() {
        // Implementation for saving new category
        console.log('Save new category');
    }

    function handleImageDelete(event) {
        const button = event.target.closest('.delete-image-btn');
        if (!button) return;

        const postId = button.dataset.postId;
        const attachmentId = button.dataset.attachmentId;
        const filename = button.dataset.filename;

        if (!confirm(`画像「${filename}」を削除しますか？`)) {
            return;
        }

        fetch(`/posts/${postId}/delete_image`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': getCSRFToken(),
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({attachment_id: attachmentId})
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Remove the image card from DOM
                    const imageCard = document.getElementById(`image-card-${attachmentId}`);
                    if (imageCard) {
                        imageCard.remove();
                    }
                    showSuccess(data.message);
                } else {
                    showError(data.message || '画像の削除に失敗しました');
                }
            })
            .catch(error => {
                console.error('Delete error:', error);
                showError('画像の削除中にエラーが発生しました');
            });
    }

    function handleVideoDelete(event) {
        console.log('Delete button clicked'); // デバッグ用
        const button = event.target.closest('.delete-video-btn');
        console.log('Button found:', button); // デバッグ用
        if (!button) return;

        const postId = button.dataset.postId;
        const attachmentId = button.dataset.attachmentId;
        const filename = button.dataset.filename;

        if (!confirm(`動画「${filename}」を削除しますか？`)) {
            return;
        }

        fetch(`/posts/${postId}/delete_video`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': getCSRFToken(),
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({attachment_id: attachmentId})
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Remove the video card from DOM
                    const videoCard = document.getElementById(`video-card-${attachmentId}`);
                    if (videoCard) {
                        videoCard.remove();
                    }
                    showSuccess(data.message);
                } else {
                    showError(data.message || '動画の削除に失敗しました');
                }
            })
            .catch(error => {
                console.error('Delete error:', error);
                showError('動画の削除中にエラーが発生しました');
            });
    }

    function insertExistingMedia(event, type) {
        const button = event.target.closest('.insert-existing-image, .insert-existing-video');
        if (!button) return;

        const filename = button.dataset.filename;
        const url = button.dataset.url;
        const textarea = document.getElementById('contentTextarea');

        if (!textarea || !filename) return;

        let markdownLink;
        if (type === 'image' || button.classList.contains('insert-existing-image')) {
            markdownLink = `![${filename}](${url})\n\n`;
        } else {
            markdownLink = `[${filename}](${url})\n\n`;
        }

        insertMarkdownAtCursor(textarea, markdownLink);
        showSuccess(`${type === 'image' ? '画像' : '動画'}「${filename}」を挿入しました`);
    }

    function addMarkdownShortcuts(textarea) {
        // Implementation for markdown shortcuts
        console.log('Add markdown shortcuts to textarea');
    }

    function insertMarkdownAtCursor(textarea, text) {
        if (!textarea) return;

        console.log('insertMarkdownAtCursor called with text:', text);

        // CodeMirrorエディターコントローラーの取得
        const codeEditorElement = textarea.closest('[data-controller*="code-editor"]');
        if (codeEditorElement) {
            console.log('Found code-editor element:', codeEditorElement);

            // Stimulus 3.x の正しいコントローラー取得方法
            const application = window.Stimulus || window.Application;
            if (application) {
                try {
                    // Stimulus application からコントローラーを取得
                    const controller = application.getControllerForElementAndIdentifier(codeEditorElement, 'code-editor');
                    if (controller && controller.insertText) {
                        console.log('Using Stimulus controller insertText method');
                        controller.insertText(text);
                        return;
                    }
                } catch (error) {
                    console.warn('Failed to get controller via Stimulus application:', error);
                }
            }

            // 代替方法：要素に直接格納されているコントローラーを参照
            if (codeEditorElement.controller && codeEditorElement.controller.insertText) {
                console.log('Using element.controller insertText method');
                codeEditorElement.controller.insertText(text);
                return;
            }

            // 代替方法2：Stimulus内部のコントローラーマップを参照
            if (codeEditorElement._stimulus_controllers) {
                const codeEditorController = codeEditorElement._stimulus_controllers.find(c => c.identifier === 'code-editor');
                if (codeEditorController && codeEditorController.insertText) {
                    console.log('Using _stimulus_controllers insertText method');
                    codeEditorController.insertText(text);
                    return;
                }
            }

            // 代替方法3：data属性を使ったイベント発火
            const customEvent = new CustomEvent('code-editor:insert-text', {
                detail: { text: text }
            });
            codeEditorElement.dispatchEvent(customEvent);
            console.log('Dispatched code-editor:insert-text event');

            // イベントが処理されたかを確認するため、少し待機してからフォールバックを実行
            setTimeout(() => {
                // まだテキストが挿入されていない場合のみフォールバック実行
                if (!textarea.value.includes(text.trim())) {
                    console.log('Event insertion failed, using fallback method');
                    fallbackTextInsertion(textarea, text);
                }
            }, 100);
            return;
        }

        // 最終フォールバック: 通常のテキストエリア処理
        console.log('Using fallback text insertion method');
        fallbackTextInsertion(textarea, text);
    }

    function fallbackTextInsertion(textarea, text) {
        const start = textarea.selectionStart ?? textarea.value.length;
        const end = textarea.selectionEnd ?? textarea.value.length;
        const currentValue = textarea.value;

        textarea.value = currentValue.substring(0, start) + text + currentValue.substring(end);
        const newPos = start + text.length;
        textarea.selectionStart = textarea.selectionEnd = newPos;
        textarea.focus();
        textarea.dispatchEvent(new Event('input'));
        console.log('Fallback text insertion completed');
    }

    function showError(message) {
        console.error(message);
        showAlert(message, 'danger');
    }

    function showSuccess(message) {
        console.log(message);
        showAlert(message, 'success');
    }

    function showAlert(message, type) {
        // Create or update alert element
        let alertContainer = document.getElementById('dynamicAlerts');
        if (!alertContainer) {
            alertContainer = document.createElement('div');
            alertContainer.id = 'dynamicAlerts';
            alertContainer.className = 'position-fixed top-0 start-50 translate-middle-x';
            alertContainer.style.zIndex = '1060';
            alertContainer.style.marginTop = '20px';
            document.body.appendChild(alertContainer);
        }

        const alertElement = document.createElement('div');
        alertElement.className = `alert alert-${type} alert-dismissible fade show`;
        alertElement.innerHTML = `
    <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} me-2"></i>
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;

        alertContainer.appendChild(alertElement);

        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (alertElement.parentNode) {
                alertElement.remove();
            }
        }, 5000);
    }

    // 更新進捗モーダル管理
    function initializeUpdateProgressModal() {
        console.log('Initializing update progress modal...');
        
        const form = document.querySelector('form[data-turbo="false"]');
        const submitBtn = document.getElementById('updateSubmitBtn');
        const progressModal = document.getElementById('updateProgressModal');

        console.log('Elements found:', {
            form: !!form,
            submitBtn: !!submitBtn,
            progressModal: !!progressModal,
            bootstrap: typeof bootstrap !== 'undefined'
        });

        if (form && submitBtn && progressModal) {
            // Bootstrap 5の確認
            if (typeof bootstrap === 'undefined') {
                console.error('Bootstrap is not loaded. Modal will not work.');
                return;
            }

            // 既存のイベントリスナーを削除
            submitBtn.removeEventListener('click', handleUpdateSubmit);
            
            // 新しいイベントリスナーを追加
            submitBtn.addEventListener('click', handleUpdateSubmit);
            console.log('Update progress modal initialized successfully');
        } else {
            console.warn('Required elements not found for update progress modal');
        }
    }

    // フォーム送信ハンドラー
    function handleUpdateSubmit(event) {
        console.log('Update submit button clicked');
        
        // デフォルトの送信を一時停止
        event.preventDefault();
        
        const progressModal = document.getElementById('updateProgressModal');
        const form = document.querySelector('form[data-turbo="false"]');
        
        if (!progressModal || !form) {
            console.error('Required elements not found');
            // フォールバック: 通常の送信
            form?.submit();
            return;
        }

        try {
            // モーダルを表示
            const modal = new bootstrap.Modal(progressModal, {
                backdrop: 'static',
                keyboard: false
            });
            modal.show();

            console.log('Modal shown, starting progress animation');
            
            // 進捗アニメーション開始
            startUpdateProgress();

            // 少し遅延してからフォーム送信（モーダル表示を確実にするため）
            setTimeout(() => {
                console.log('Submitting form...');
                form.submit();
            }, 100);

        } catch (error) {
            console.error('Error showing modal:', error);
            // エラー時は通常の送信にフォールバック
            form.submit();
        }
    }

    // 更新進捗アニメーション
    function startUpdateProgress() {
        const progressBar = document.getElementById('updateProgressBar');
        const progressText = document.getElementById('updateProgressText');
        const statusText = document.getElementById('updateStatusText');
        const details = document.getElementById('updateDetails');

        let progress = 0;
        const steps = [
            { progress: 20, status: 'フォームデータを検証中...', detail: 'データの整合性を確認しています' },
            { progress: 40, status: 'ファイルをアップロード中...', detail: '画像・動画ファイルを処理しています' },
            { progress: 60, status: 'データベースを更新中...', detail: '投稿情報を保存しています' },
            { progress: 80, status: '最終処理中...', detail: 'インデックスを更新しています' },
            { progress: 100, status: '完了', detail: '更新が完了しました' }
        ];

        let currentStep = 0;

        const updateProgress = () => {
            if (currentStep < steps.length) {
                const step = steps[currentStep];

                // プログレスバー更新
                progressBar.style.width = step.progress + '%';
                progressBar.setAttribute('aria-valuenow', step.progress);
                progressText.textContent = step.progress + '%';

                // ステータス更新
                statusText.textContent = step.status;
                details.textContent = step.detail;

                currentStep++;

                // 次のステップまでの待機時間（実際の処理時間に応じて調整）
                setTimeout(updateProgress, 800);
            }
        };

        // 最初のステップ実行
        setTimeout(updateProgress, 200);
    }

    // フォーム送信完了時の処理
    function handleUpdateComplete(success = true) {
        const progressModal = document.getElementById('updateProgressModal');
        const modal = bootstrap.Modal.getInstance(progressModal);

        if (success) {
            // 成功時は自動的にモーダルを閉じる
            setTimeout(() => {
                modal.hide();
            }, 1000);
        } else {
            // エラー時はエラー表示に変更
            showUpdateError();
        }
    }

    // エラー時の表示変更
    function showUpdateError() {
        const progressBar = document.getElementById('updateProgressBar');
        const progressText = document.getElementById('updateProgressText');
        const statusText = document.getElementById('updateStatusText');
        const details = document.getElementById('updateDetails');
        const modalTitle = document.getElementById('updateProgressModalLabel');

        // エラー表示に変更
        progressBar.className = 'progress-bar bg-danger';
        progressBar.style.width = '100%';
        progressText.textContent = 'エラー';
        statusText.textContent = '更新に失敗しました';
        details.textContent = 'もう一度お試しください';
        modalTitle.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>エラーが発生しました';

        // 閉じるボタンを追加
        const modalBody = progressModal.querySelector('.modal-body');
        const closeButton = document.createElement('button');
        closeButton.className = 'btn btn-secondary mt-3';
        closeButton.textContent = '閉じる';
        closeButton.onclick = () => {
            const modal = bootstrap.Modal.getInstance(progressModal);
            modal.hide();
        };
        modalBody.appendChild(closeButton);
    }

    // Global functions for compatibility
    window.initializeFormFeatures = initializeFormFeatures;
    window.performAutoSave = performAutoSave;

    // Initialize all features when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        initializeUpdateProgressModal();
    });
</script>