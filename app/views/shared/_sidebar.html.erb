
<!-- 左側サイドバー - カテゴリーとタグ -->
<div class="col-12 col-lg-3 order-2 order-lg-1 mb-4 mb-lg-0">
  <!-- カテゴリー一覧 -->
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">カテゴリー</h5>
    </div>
    <%= form_with url: posts_path, method: :get, local: true, class: "mb-0" do |form| %>
      <div class="card-body">
        <%= form.collection_select :category_id, Category.all, :id, :full_name,
                                   { prompt: "すべてのカテゴリー", selected: params[:category_id] },
                                   { class: "form-select", id: "category_select" } %>
      </div>

      <div class="card-header">
        <h5 class="mb-0">投稿タイプ</h5>
      </div>

      <div class="card-body">
        <%= form.collection_select :post_type_id, PostType.all, :id, :name,
                                   { prompt: "すべての投稿タイプ", selected: params[:post_type_id] },
                                   { class: "form-select", id: "post_type_select" } %>
      </div>

      <div class="card-header">
        <h5 class="mb-0">投稿期間検索</h5>
      </div>

      <div class="card-body">
        <%= form.text_field :date_range, 
                            placeholder: "期間を選択してください",
                            value: params[:date_range],
                            class: "form-control",
                            id: "date_range_picker",
                            readonly: true,
                            data: {
                              controller: "flatpickr",
                              flatpickr_target: "input",
                              flatpickr_mode_value: "range",
                              flatpickr_date_format_value: "Y/m/d",
                              flatpickr_locale_value: "ja"
                            } %>
        <div class="mt-2">
          <%= form.submit "検索", class: "btn btn-primary btn-sm" %>
          <% if params[:date_range].present? %>
            <%= link_to "クリア", posts_path(category_id: params[:category_id], post_type_id: params[:post_type_id]), class: "btn btn-outline-secondary btn-sm ms-1" %>
          <% end %>
        </div>
</div>

<% end %>
  </div>
</div>

<script nonce="<%= content_security_policy_nonce %>">
  document.addEventListener('DOMContentLoaded', function() {
    var category = document.getElementById('category_select');
    var postType = document.getElementById('post_type_select');

    function submitParentForm(el) {
      if (!el) return;
      var form = el.closest('form');
      if (form) { form.submit(); }
    }

    if (category) {
      category.addEventListener('change', function(){ submitParentForm(category); });
    }
    if (postType) {
      postType.addEventListener('change', function(){ submitParentForm(postType); });
    }
  });
</script>
