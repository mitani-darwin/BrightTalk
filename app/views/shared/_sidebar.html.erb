
<!-- 左側サイドバー - カテゴリーとタグ -->
<div class="order-2 w-full lg:order-1 lg:w-1/4">
  <div class="card mb-6">
    <div class="card-section px-5 py-4">
      <h5 class="text-base font-semibold text-slate-800">カテゴリー</h5>
    </div>
    <%= form_with url: posts_path, method: :get, local: true, class: "mb-0" do |form| %>
      <div class="card-section px-5 py-4">
        <%= form.collection_select :category_id, Category.all, :id, :full_name,
                                   { prompt: "すべてのカテゴリー", selected: params[:category_id] },
                                   { class: "input", id: "category_select" } %>
      </div>

      <div class="card-section px-5 py-4">
        <h5 class="text-base font-semibold text-slate-800">投稿タイプ</h5>
        <div class="mt-3">
          <%= form.collection_select :post_type_id, PostType.all, :id, :name,
                                     { prompt: "すべての投稿タイプ", selected: params[:post_type_id] },
                                     { class: "input", id: "post_type_select" } %>
        </div>
      </div>

      <div class="px-5 py-4">
        <h5 class="text-base font-semibold text-slate-800">投稿期間検索</h5>
        <div class="mt-3 space-y-2">
          <%= form.text_field :date_range,
                              placeholder: "期間を選択してください",
                              value: params[:date_range],
                              class: "input",
                              id: "date_range_picker",
                              readonly: true,
                              data: {
                                controller: "flatpickr",
                                flatpickr_target: "input",
                                flatpickr_mode_value: "range",
                                flatpickr_date_format_value: "Y/m/d",
                                flatpickr_locale_value: "ja"
                              } %>
          <div class="flex flex-wrap gap-2">
            <%= form.submit "検索", class: "btn btn-primary text-sm" %>
            <% if params[:date_range].present? %>
              <%= link_to "クリア", posts_path(category_id: params[:category_id], post_type_id: params[:post_type_id]), class: "btn btn-secondary text-sm" %>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
  </div>
</div>

<script nonce="<%= content_security_policy_nonce %>">
  document.addEventListener('DOMContentLoaded', function() {
    var category = document.getElementById('category_select');
    var postType = document.getElementById('post_type_select');

    function submitParentForm(el) {
      if (!el) return;
      var form = el.closest('form');
      if (form) { form.submit(); }
    }

    if (category) {
      category.addEventListener('change', function(){ submitParentForm(category); });
    }
    if (postType) {
      postType.addEventListener('change', function(){ submitParentForm(postType); });
    }
  });
</script>
