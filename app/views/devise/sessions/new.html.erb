<section class="mx-auto w-full max-w-lg px-4 py-10 sm:px-6 lg:px-8">
  <div class="rounded-2xl border border-slate-200 bg-white shadow-sm">
    <div class="border-b border-slate-200 px-6 py-5 text-center">
      <h3 class="text-lg font-semibold text-slate-900">
        <i class="fas fa-fingerprint mr-2 text-slate-600"></i>ログイン
      </h3>
      <p class="mt-2 text-sm text-slate-500">パスキーとパスワードの両方に対応しています。</p>
    </div>

    <div class="px-6 py-6">
      <div class="rounded-xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm text-slate-700" role="note">
        <strong class="font-semibold text-slate-900">推奨：</strong>パスキーはフィッシング耐性が高く、パスワードより安全です。
      </div>

      <% if resource.errors.any? %>
        <div class="mt-4 rounded-xl border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-700" role="alert">
          <div class="flex items-start gap-2">
            <i class="fas fa-exclamation-triangle mt-0.5 text-rose-500"></i>
            <div>
              <strong class="font-semibold">エラーが発生しました</strong>
              <ul class="mt-2 list-disc pl-5">
                <% resource.errors.full_messages.each do |message| %>
                  <li><%= message %></li>
                <% end %>
              </ul>
            </div>
          </div>
        </div>
      <% end %>

      <div class="mt-6">
        <label for="email" class="text-sm font-medium text-slate-700">メールアドレス</label>
        <input type="email"
               id="email"
               class="mt-2 h-11 w-full rounded-xl border border-slate-200 bg-white px-4 text-base text-slate-700 shadow-sm focus:border-slate-300 focus:ring-2 focus:ring-slate-200"
               required
               autofocus
               autocomplete="email">
        <div class="mt-2 text-xs text-rose-500">メールアドレスを入力してください</div>
      </div>

      <div class="mt-4 grid gap-2">
        <button type="button"
                id="passkey-login-btn"
                class="inline-flex h-11 items-center justify-center gap-2 rounded-xl bg-slate-900 px-4 text-sm font-semibold text-white shadow-sm transition hover:bg-slate-800 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-400 focus-visible:ring-offset-2">
          <i class="fas fa-fingerprint"></i>パスキーでログイン（推奨）
        </button>
      </div>

      <div id="status-message" class="mt-4 hidden" role="alert"></div>

      <details class="mt-6 rounded-xl border border-slate-200 bg-white px-4 py-3">
        <summary class="cursor-pointer text-sm font-medium text-slate-600 hover:text-slate-900">
          その他の方法でログイン
        </summary>
        <div class="mt-4 text-sm text-slate-500">
          パスキーが利用できない場合はメールアドレスとパスワードでログインできます。
        </div>
        <div class="mt-4">
          <%= form_with scope: resource_name, url: session_path(resource_name), local: true, class: "space-y-4" do |f| %>
            <div>
              <%= f.label :email, "メールアドレス", class: "text-sm font-medium text-slate-700" %>
              <%= f.email_field :email, class: "mt-2 h-11 w-full rounded-xl border border-slate-200 bg-white px-4 text-base text-slate-700 shadow-sm focus:border-slate-300 focus:ring-2 focus:ring-slate-200", autocomplete: "email" %>
            </div>
            <div>
              <%= f.label :password, "パスワード", class: "text-sm font-medium text-slate-700" %>
              <%= f.password_field :password, class: "mt-2 h-11 w-full rounded-xl border border-slate-200 bg-white px-4 text-base text-slate-700 shadow-sm focus:border-slate-300 focus:ring-2 focus:ring-slate-200", autocomplete: "current-password" %>
            </div>
            <div>
              <%= f.submit "メールとパスワードでログイン", class: "inline-flex h-11 w-full items-center justify-center rounded-xl border border-slate-200 bg-white px-4 text-sm font-semibold text-slate-700 shadow-sm transition hover:bg-slate-50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-300" %>
            </div>
          <% end %>
        </div>
      </details>
    </div>
  </div>
</section>

<!-- パスキー認証用JavaScript -->
<!-- JavaScript is already loaded in the application layout head section -->

<script nonce="<%= content_security_policy_nonce %>">
    (function() {
        function setupPasskeyLogin() {
            const emailInput = document.getElementById('email');
            const passkeyLoginBtn = document.getElementById('passkey-login-btn');
            const statusMessage = document.getElementById('status-message');
            if (!emailInput || !passkeyLoginBtn || !statusMessage) return;

            const statusClasses = {
                info: 'rounded-xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm text-slate-700',
                success: 'rounded-xl border border-emerald-200 bg-emerald-50 px-4 py-3 text-sm text-emerald-700',
                warning: 'rounded-xl border border-amber-200 bg-amber-50 px-4 py-3 text-sm text-amber-700',
                danger: 'rounded-xl border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-700'
            };

            function showStatus(message, type = 'info') {
                statusMessage.textContent = message;
                statusMessage.className = statusClasses[type] || statusClasses.info;
                statusMessage.classList.remove('hidden');
                if (type === 'success') {
                    setTimeout(() => { statusMessage.classList.add('hidden'); }, 3000);
                }
            }

            async function performPasskeyAuth(event) {
                const email = emailInput.value.trim();
                if (!email) { 
                    showStatus('メールアドレスを入力してください', 'danger'); 
                    return; 
                }

                passkeyLoginBtn.disabled = true;
                passkeyLoginBtn.classList.add('opacity-60', 'cursor-not-allowed');
                showStatus('パスキー認証を開始しています...', 'info');

                try {
                    const platformSupport = await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable();
                    console.log('Platform authenticator available:', platformSupport);

                    if (!platformSupport) {
                        showStatus('このデバイスはパスキー認証に対応していません', 'warning');
                        passkeyLoginBtn.disabled = false;
                        passkeyLoginBtn.classList.remove('opacity-60', 'cursor-not-allowed');
                        return;
                    }
                } catch (error) {
                    console.error('Platform authenticator check failed:', error);
                }

                if (!window.startPasskeyAuthentication) {
                    showStatus('パスキーモジュールの読み込み中...', 'info');
                    for (let i = 0; i < 30; i++) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        if (window.startPasskeyAuthentication) break;
                    }
                }

                if (!window.startPasskeyAuthentication) {
                    showStatus('パスキーモジュールの読み込みに失敗しました', 'danger');
                    passkeyLoginBtn.disabled = false;
                    passkeyLoginBtn.classList.remove('opacity-60', 'cursor-not-allowed');
                    return;
                }

                try {
                    const response = await fetch('/passkey_authentications/auth_options', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                        },
                        body: JSON.stringify({ email })
                    });
                    
                    if (!response.ok) {
                        let msg = '認証オプションの取得に失敗しました';
                        try { const err = await response.json(); msg = err.error || msg; } catch(e) {}
                        throw new Error(msg);
                    }
                    
                    const authData = await response.json();
                    if (!authData.passkey_options) throw new Error('このメールアドレスにはパスキーが登録されていません');

                    console.log('Authentication options from server:', authData.passkey_options);
                    console.log('AuthenticatorSelection:', authData.passkey_options.authenticatorSelection);

                    showStatus('パスキーでの認証を求められています...', 'info');

                    const credentialData = await window.startPasskeyAuthentication(authData.passkey_options);
                    
                    const verifyResponse = await fetch('/passkey_authentications', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                        },
                        body: JSON.stringify({ credential: credentialData })
                    });

                    if (!verifyResponse.ok) {
                        throw new Error('パスキー認証の検証に失敗しました');
                    }

                    const result = await verifyResponse.json();
                    showStatus('認証に成功しました。リダイレクトしています...', 'success');
                    
                    window.location.href = result.redirect_url || '/';

                } catch (error) {
                    console.error('Passkey authentication failed:', error);
                    showStatus(`パスキー認証に失敗しました: ${error.message}`, 'danger');
                } finally {
                    passkeyLoginBtn.disabled = false;
                    passkeyLoginBtn.classList.remove('opacity-60', 'cursor-not-allowed');
                }
            }

            const btnClone = passkeyLoginBtn.cloneNode(true);
            passkeyLoginBtn.parentNode.replaceChild(btnClone, passkeyLoginBtn);

            btnClone.addEventListener('click', performPasskeyAuth);
            emailInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') { e.preventDefault(); performPasskeyAuth(); }
            });
        }

        document.addEventListener('turbo:load', setupPasskeyLogin);
        document.addEventListener('turbo:render', setupPasskeyLogin);

        if (document.readyState !== 'loading') {
            setupPasskeyLogin();
        } else {
            document.addEventListener('DOMContentLoaded', setupPasskeyLogin);
        }

        async function checkAuthenticatorCapabilities() {
            try {
                const available = await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable();
                console.log('Platform authenticator available:', available);

                if (available) {
                    console.log('Pass Key should be available');
                } else {
                    console.log('Pass Key is not available on this device/browser');
                }

                if (navigator.credentials && navigator.credentials.get) {
                    console.log('WebAuthn API is supported');
                } else {
                    console.log('WebAuthn API is not supported');
                }
            } catch (error) {
                console.error('Error checking authenticator capabilities:', error);
            }
        }
    })();
</script>
