<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeEditor Vertical Size Fix Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- CodeMirror CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.css">
    <style>
        body {
            min-height: 100vh;
            padding-bottom: 120px;
        }
        .footer {
            background-color: #f8f9fa;
            padding: 20px 0;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
        }
        .sidebar {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
        }
        .measurement-text {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            z-index: 1001;
            max-width: 400px;
            font-size: 12px;
        }
        .status-indicator {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
        }
        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .size-indicator {
            position: absolute;
            right: -30px;
            width: 25px;
            background: rgba(0, 123, 255, 0.3);
            border: 2px solid #007bff;
            z-index: 998;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>CodeEditorç¸¦ã‚µã‚¤ã‚ºä¿®æ­£æ¤œè¨¼ãƒ†ã‚¹ãƒˆ</h1>
        <p>ä¿®æ­£ã•ã‚ŒãŸCodeMirrorã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã®ç¸¦ã‚µã‚¤ã‚ºèª¿æ•´æ©Ÿèƒ½ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚</p>
        
        <div id="testStatus" class="status-indicator status-error">
            CodeMirroråˆæœŸåŒ–ä¸­...
        </div>
        
        <!-- Form layout matching Rails structure -->
        <div class="row" id="formContainer" style="height: calc(100vh - 140px);">
            <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆå·¦å´ï¼‰ -->
            <div class="col-md-4" style="height: 100%;">
                <div class="sidebar" style="height: 100%;">
                    <h5>Sidebar</h5>
                    <div class="mb-3">
                        <label class="form-label">è¦ç‚¹ãƒ»ãƒã‚¤ãƒ³ãƒˆ</label>
                        <textarea class="form-control" rows="4"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ã‚¿ã‚¤ãƒˆãƒ« <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" placeholder="æŠ•ç¨¿ã‚¿ã‚¤ãƒˆãƒ«">
                    </div>
                </div>
            </div>

            <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆå³å´ï¼‰ -->
            <div class="col-md-8 d-flex flex-column" style="height: 100%; position: relative;">
                <!-- Key points field -->
                <div class="mb-3">
                    <label class="form-label">è¦ç‚¹ãƒ»ãƒã‚¤ãƒ³ãƒˆ</label>
                    <textarea class="form-control" rows="4" placeholder="ä¾‹ï¼š&#10;1. ç’°å¢ƒæ§‹ç¯‰ã®æ‰‹é †&#10;2. åŸºæœ¬çš„ãªã‚³ãƒãƒ³ãƒ‰ã®ä½¿ã„æ–¹&#10;3. ã‚ˆãã‚ã‚‹ã‚¨ãƒ©ãƒ¼ã¨ãã®å¯¾å‡¦æ³•"></textarea>
                    <div class="form-text">èª­è€…ã«ä¼ãˆãŸã„ä¸»è¦ãªãƒã‚¤ãƒ³ãƒˆã‚’ç®‡æ¡æ›¸ãã§è¨˜å…¥ã—ã¦ãã ã•ã„ã€‚</div>
                </div>

                <!-- Title field -->
                <div class="mb-3">
                    <label class="form-label">
                        ã‚¿ã‚¤ãƒˆãƒ«
                        <span class="text-danger">*</span>
                        <small class="text-muted">(å¸¸ã«å¿…é ˆ)</small>
                    </label>
                    <input type="text" class="form-control" required placeholder="æŠ•ç¨¿ã‚¿ã‚¤ãƒˆãƒ«">
                </div>

                <!-- Content field with CodeMirror -->
                <div class="mb-3 flex-grow-1 d-flex flex-column">
                    <label class="form-label">
                        å†…å®¹ (CodeMirrorä¿®æ­£ç‰ˆ)
                        <span class="text-danger">*</span>
                        <small class="text-muted">(å¸¸ã«å¿…é ˆ)</small>
                    </label>
                    <div class="flex-grow-1 d-flex flex-column" style="position: relative;">
                        <textarea 
                            class="form-control flex-grow-1" 
                            id="contentTextarea"
                            required
                            style="overflow-y: scroll; resize:none; height: 100%; max-height: 600px; font-family: Monaco, 'Lucida Console', monospace;" 
                            placeholder="å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„&#10;&#10;ğŸ”§ CodeMirrorä¿®æ­£å†…å®¹:&#10;1. æœªå®šç¾©å¤‰æ•°maxHeightã‚’effectiveMaxHeightã«ä¿®æ­£&#10;2. setSize()ç›´æ¥å‘¼ã³å‡ºã—ã‚’å‰Šé™¤&#10;3. CSS max-heightã§åˆ¶å¾¡ã™ã‚‹ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã«å¤‰æ›´&#10;4. HTMLã®600pxè¨­å®šã‚’å°Šé‡&#10;&#10;âœ… æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œ:&#10;- æœ€å¤§600pxã¾ã§ç¸¦ã«æ‹¡å¼µ&#10;- ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆã‚µã‚¤ã‚ºã«å¿œã˜ã¦å‹•çš„èª¿æ•´&#10;- ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ©Ÿèƒ½ä»˜ã&#10;- ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ&#10;&#10;ã“ã®ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã¯CodeMirrorã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã«å¤‰æ›ã•ã‚Œã¾ã™ã€‚&#10;é•·ã„ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ©Ÿèƒ½ã‚’ãƒ†ã‚¹ãƒˆã—ã¦ãã ã•ã„ã€‚&#10;&#10;## è¿½åŠ ãƒ†ã‚¹ãƒˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„&#10;Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.&#10;&#10;Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.&#10;&#10;Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, totam rem aperiam, eaque ipsa quae ab illo inventore veritatis et quasi architecto beatae vitae dicta sunt explicabo."></textarea>
                        <div class="size-indicator" id="sizeIndicator">
                            <small style="writing-mode: vertical-lr; transform: rotate(180deg); font-size: 10px; color: #007bff; font-weight: bold;">SIZE</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Fixed buttons -->
    <div class="container" style="bottom: 100px; left: 0; right: 0;">
        <div class="row">
            <div class="col-md-4"></div>
            <div class="col-md-8">
                <div class="d-flex gap-2 mt-4 mb-3">
                    <button class="btn btn-primary flex-fill">æŠ•ç¨¿</button>
                    <button class="btn btn-outline-secondary flex-fill">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p class="text-center mb-0">Footer content</p>
        </div>
    </footer>

    <!-- Measurement display -->
    <div class="measurement-text" id="measurements">
        åˆæœŸåŒ–ä¸­...
    </div>

    <!-- CodeMirror JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/markdown/markdown.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let editor;
        let resizeHandler;
        let orientationHandler;
        
        // Modified code_editor_controller.js logic implementation
        function initializeCodeMirror() {
            const textarea = document.getElementById('contentTextarea');
            const measurements = document.getElementById('measurements');
            const testStatus = document.getElementById('testStatus');
            
            if (textarea && window.CodeMirror) {
                try {
                    // Initialize CodeMirror
                    editor = CodeMirror.fromTextArea(textarea, {
                        mode: 'markdown',
                        theme: 'default',
                        lineNumbers: true,
                        lineWrapping: true,
                        indentUnit: 2,
                        tabSize: 2,
                        extraKeys: {
                            "Ctrl-Space": "autocomplete"
                        }
                    });
                    
                    console.log('CodeMirror initialized successfully');
                    testStatus.textContent = 'âœ… CodeMirroråˆæœŸåŒ–æˆåŠŸ';
                    testStatus.className = 'status-indicator status-success';
                    
                    // Initialize dynamic sizing (fixed version)
                    initializeDynamicSizing();
                    
                    // Update measurements when editor changes
                    editor.on('refresh', updateMeasurements);
                    editor.on('change', updateMeasurements);
                    
                } catch (error) {
                    console.error('CodeMirror initialization failed:', error);
                    testStatus.textContent = 'âŒ CodeMirroråˆæœŸåŒ–å¤±æ•—: ' + error.message;
                    testStatus.className = 'status-indicator status-error';
                }
                
            } else {
                console.error('CodeMirror or textarea not found');
                testStatus.textContent = 'âŒ CodeMirrorã¾ãŸã¯textareaãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
                testStatus.className = 'status-indicator status-error';
            }
        }
        
        function initializeDynamicSizing() {
            console.log('å‹•çš„ã‚µã‚¤ã‚ºèª¿æ•´ã‚’åˆæœŸåŒ–ä¸­...');
            
            // Initial size adjustment
            adjustEditorSize();
            
            // Resize event listener with debounce
            resizeHandler = debounce(() => adjustEditorSize(), 250);
            window.addEventListener('resize', resizeHandler);
            
            // Device orientation change event
            orientationHandler = () => setTimeout(() => adjustEditorSize(), 500);
            window.addEventListener('orientationchange', orientationHandler);
            
            console.log('å‹•çš„ã‚µã‚¤ã‚ºèª¿æ•´ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸ');
        }
        
        function adjustEditorSize() {
            if (!editor) return;

            // HTMLã§è¨­å®šã•ã‚ŒãŸæœ€å¤§é«˜ã•ã‚’å°Šé‡ï¼ˆ600pxï¼‰
            const desiredMaxHeight = 600;
            const minHeight = 300;

            const viewportHeight = window.innerHeight;
            const buttonAreaHeight = 100; // ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢
            const headerHeight = getEstimatedHeaderHeight();
            const safetyMargin = getDeviceSpecificAdjustments().safetyMargin;
            const availableHeight = viewportHeight - buttonAreaHeight - headerHeight - safetyMargin;
            
            // æœ€çµ‚çš„ãªé«˜ã•ã‚’æ±ºå®šï¼ˆ600pxä»¥ä¸‹ã€ã‹ã¤åˆ©ç”¨å¯èƒ½é«˜ã•ä»¥ä¸‹ï¼‰
            const effectiveMaxHeight = Math.max(minHeight, Math.min(desiredMaxHeight, availableHeight));
            
            // wrapperè¦ç´ ã®max-heightã‚’è¨­å®šï¼ˆç›´æ¥ã‚µã‚¤ã‚ºè¨­å®šã¯è¡Œã‚ãªã„ï¼‰
            const wrapper = editor.getWrapperElement();
            if (wrapper) {
                wrapper.style.maxHeight = `${effectiveMaxHeight}px`;
                wrapper.style.height = 'auto';
                wrapper.style.overflow = 'hidden';
            }
            
            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚³ãƒ³ãƒ†ãƒŠã®è¨­å®š
            const scrollElement = editor.getScrollerElement();
            if (scrollElement) {
                scrollElement.style.maxHeight = `${effectiveMaxHeight}px`;
                scrollElement.style.overflowY = 'auto';
            }
            
            editor.refresh();
            
            console.log(`å‹•çš„ã‚µã‚¤ã‚ºèª¿æ•´å®Œäº†: max-height ${effectiveMaxHeight}px (ç›®æ¨™: ${desiredMaxHeight}px)`);
            
            // Update measurements
            updateMeasurements();
        }
        
        function getEstimatedHeaderHeight() {
            const navbar = document.querySelector('.navbar, nav, header');
            return navbar ? navbar.offsetHeight + 20 : 80;
        }
        
        function getDeviceSpecificAdjustments() {
            const userAgent = navigator.userAgent;
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent);
            const isIOS = /iPad|iPhone|iPod/.test(userAgent);
            
            return {
                isMobile,
                isIOS,
                safetyMargin: isMobile ? 40 : 20,
                maxContentRatio: isMobile ? 0.5 : 0.6
            };
        }
        
        function debounce(func, wait) {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }
        
        function updateMeasurements() {
            const measurements = document.getElementById('measurements');
            const sizeIndicator = document.getElementById('sizeIndicator');
            
            if (editor && measurements) {
                const editorWrapper = editor.getWrapperElement();
                const editorScrollElement = editor.getScrollerElement();
                
                const editorHeight = editorWrapper.offsetHeight;
                const editorMaxHeight = window.getComputedStyle(editorWrapper).maxHeight;
                const scrollMaxHeight = window.getComputedStyle(editorScrollElement).maxHeight;
                
                const viewportHeight = window.innerHeight;
                const deviceInfo = getDeviceSpecificAdjustments();
                
                // Position size indicator
                if (sizeIndicator && editorWrapper) {
                    const rect = editorWrapper.getBoundingClientRect();
                    const container = document.querySelector('.col-md-8');
                    const containerRect = container.getBoundingClientRect();
                    sizeIndicator.style.top = (rect.top - containerRect.top) + 'px';
                    sizeIndicator.style.height = editorHeight + 'px';
                }
                
                measurements.innerHTML = `
                    <strong>ğŸ”§ CodeMirrorç¸¦ã‚µã‚¤ã‚ºä¿®æ­£æ¤œè¨¼</strong><br><br>
                    
                    <strong>ä¿®æ­£å†…å®¹:</strong><br>
                    âœ… æœªå®šç¾©å¤‰æ•°maxHeightã‚’ä¿®æ­£<br>
                    âœ… setSize()ç›´æ¥å‘¼ã³å‡ºã—ã‚’å‰Šé™¤<br>
                    âœ… CSS max-heightã§åˆ¶å¾¡<br>
                    âœ… 600pxè¨­å®šã‚’å°Šé‡<br><br>
                    
                    <strong>ç¾åœ¨ã®æ¸¬å®šå€¤:</strong><br>
                    ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆ: ${viewportHeight}px<br>
                    ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼é«˜ã•: ${editorHeight}px<br>
                    æœ€å¤§é«˜ã•è¨­å®š: ${editorMaxHeight}<br>
                    ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åˆ¶é™: ${scrollMaxHeight}<br><br>
                    
                    <strong>ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±:</strong><br>
                    ã‚¿ã‚¤ãƒ—: ${deviceInfo.isMobile ? 'ãƒ¢ãƒã‚¤ãƒ«' : 'ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—'}<br>
                    å®‰å…¨ä½™ç™½: ${deviceInfo.safetyMargin}px<br><br>
                    
                    <strong>å‹•ä½œçŠ¶æ³:</strong><br>
                    ${editorHeight > 0 ? 'âœ…' : 'âŒ'} ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼è¡¨ç¤º<br>
                    ${editorMaxHeight.includes('600') ? 'âœ…' : 'âŒ'} 600pxåˆ¶é™é©ç”¨<br>
                    ${editorWrapper.scrollHeight > editorHeight ? 'âœ…' : 'âš ï¸'} ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«${editorWrapper.scrollHeight > editorHeight ? 'å¯èƒ½' : 'ãªã—'}<br>
                    ${editorHeight <= 600 ? 'âœ…' : 'âŒ'} é«˜ã•åˆ¶é™å†…<br>
                    
                    <br><strong>ç¸¦ã‚µã‚¤ã‚ºå•é¡Œ: ${editorHeight >= 400 ? 'âœ… è§£æ±ºæ¸ˆã¿' : 'âŒ æœªè§£æ±º'}</strong>
                `;
            }
        }
        
        // Initialize when page loads
        window.addEventListener('load', function() {
            setTimeout(initializeCodeMirror, 100);
        });
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (resizeHandler) {
                window.removeEventListener('resize', resizeHandler);
            }
            if (orientationHandler) {
                window.removeEventListener('orientationchange', orientationHandler);
            }
        });
        
        // Update measurements periodically
        setInterval(function() {
            if (editor) {
                updateMeasurements();
            }
        }, 3000);
    </script>
</body>
</html>